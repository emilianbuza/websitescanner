<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ğŸ’¸ Verlieren Sie tÃ¤glich â‚¬127 durch kaputtes Tracking? | Website Scanner</title>
<!-- Modern Premium Design -->
<link rel="stylesheet" href="/modern-style.css" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Theme Toggle -->
  <button class="theme-toggle" onclick="toggleTheme()" title="Theme wechseln">ğŸŒ“</button>

  <!-- Hero Section -->
  <div id="heroSection" class="hero-section">
    <div style="max-width: 800px; margin: 0 auto; padding: 0 20px;">
      <h1>ğŸ’¸ Verlieren Sie tÃ¤glich â‚¬127 durch kaputtes Tracking?</h1>
      <p class="subtitle">
        Unser 60-Sekunden-Scan findet heraus, ob Google Ads, Facebook Pixel & Co. 
        bei Ihnen blockiert sind â€“ und Sie dadurch <strong>â‚¬1.500-4.800/Monat</strong> verlieren.
      </p>
      
      <div class="cta-enhanced">
        <input type="url" id="websiteUrl" placeholder="https://ihre-website.de">
        <button onclick="startScanFromHero()">Jetzt kostenlos prÃ¼fen (60 Sek.)</button>
        <div class="trust-signals">
          <span>âœ… Ã˜ â‚¬3.200 Verlust entdeckt</span>
          <span>âœ… 89% finden kritische Probleme</span>
          <span>âœ… Sofort-LÃ¶sungen inklusive</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Urgency Banner -->
  <div id="urgencyBanner" class="urgency-banner">
    <h3>âš ï¸ Achtung: Jeden Tag warten kostet Geld!</h3>
    <p>
      <strong>Durchschnittlich verlieren Websites â‚¬127/Tag</strong> durch blockiertes Tracking.<br>
      <span style="color: #7f1d1d;">Das sind â‚¬3.800/Monat die direkt in Ihre Konkurrenz flieÃŸen.</span>
    </p>
  </div>

  <!-- Example Problems -->
  <div id="exampleSection" class="example-findings">
    <div style="max-width: 1200px; margin: 0 auto;">
      <h3>HÃ¤ufige Probleme, die wir finden:</h3>
      <div class="problem-examples">
        <div class="problem">
          <div class="problem-icon">ğŸ’¸ ğŸ“Š</div>
          <div class="problem-title">Google Analytics sammelt ohne Erlaubnis</div>
          <div class="problem-impact">â‚¬2.000 Abmahn-Risiko + Ihre Zahlen sind rechtlich nutzlos</div>
        </div>
        
        <div class="problem">
          <div class="problem-icon">ğŸ’¸ ğŸ“±</div>
          <div class="problem-title">Facebook Ads laufen blind</div>
          <div class="problem-impact">â‚¬850/Monat verschwendet, weil Conversions nicht gemessen werden</div>
        </div>
        
        <div class="problem">
          <div class="problem-icon">ğŸ’¸ ğŸ¯</div>
          <div class="problem-title">Retargeting funktioniert nicht</div>
          <div class="problem-impact">70% weniger WiederkÃ¤ufer = â‚¬1.200/Monat Umsatzverlust</div>
        </div>
        
        <div class="problem">
          <div class="problem-icon">ğŸ’¸ ğŸ”’</div>
          <div class="problem-title">Sicherheitsregeln zu streng</div>
          <div class="problem-impact">â‚¬450/Monat verloren durch blockierte Marketing-Tools</div>
        </div>
        
        <div class="problem">
          <div class="problem-icon">ğŸ’¸ ğŸ“ˆ</div>
          <div class="problem-title">TikTok/LinkedIn Pixel stumm</div>
          <div class="problem-impact">Social Media ROI nicht messbar = Blind optimieren</div>
        </div>
        
        <div class="problem">
          <div class="problem-icon">ğŸ’¸ ğŸª</div>
          <div class="problem-title">Consent-Banner funktionslos</div>
          <div class="problem-impact">Tools sammeln trotz "Ablehnen" Daten â€“ â‚¬2.000 Abmahn-Risiko</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scan Progress -->
  <div class="scan-progress" id="scanProgress">
    <div class="progress-header">
      <h3>Website wird analysiert...</h3>
      <div id="currentUrl" class="badge" style="margin-bottom: 15px;">â€“</div>
    </div>
    
    <div class="main-progress">
      <div class="progress-bar">
        <div class="progress-fill" id="mainProgressBar"></div>
      </div>
      <div class="progress-text" id="progressText">Vorbereitung... (0/4 Sessions)</div>
    </div>
    
    <div class="scan-steps">
      <div class="step pending" id="step1">
        <div class="step-icon">1</div>
        <div class="step-text">
          <div><strong>Session 1: Ohne Consent</strong></div>
          <div class="step-duration">PrÃ¼ft Standard-Verhalten (~25 Sek.)</div>
        </div>
      </div>
      
      <div class="step pending" id="step2">
        <div class="step-icon">2</div>
        <div class="step-text">
          <div><strong>Session 2: Mit Zustimmung</strong></div>
          <div class="step-duration">Simuliert "Alle akzeptieren" (~25 Sek.)</div>
        </div>
      </div>
      
      <div class="step pending" id="step3">
        <div class="step-icon">3</div>
        <div class="step-text">
          <div><strong>Session 3: Ablehnung</strong></div>
          <div class="step-duration">Simuliert "Ablehnen" (~25 Sek.)</div>
        </div>
      </div>
      
      <div class="step pending" id="step4">
        <div class="step-icon">4</div>
        <div class="step-text">
          <div><strong>Analyse & Report</strong></div>
          <div class="step-duration">Vergleicht Ergebnisse (~15 Sek.)</div>
        </div>
      </div>
    </div>
    
    <div class="live-log">
      <h4>ğŸ” Live-Details:</h4>
      <div id="liveLog">
        <div class="log-entry">Scanner wird vorbereitet...</div>
      </div>
    </div>
  </div>

  <!-- Main App -->
  <div id="mainApp" style="display: none;">
    <div class="topbar">
      <div class="topbar-inner">
        <div class="brand"><span class="dot"></span>Website Scanner <span class="preview">Â· Ergebnisse</span></div>
        <div class="urlfield">
          <input id="url" type="url" placeholder="https://ihre-website.de" />
          <button id="scanBtn" class="btn">Erneut scannen</button>
          <button id="demoBtn" class="btn alt">Demo laden</button>
        </div>
        <div class="toggle" title="Darstellung">
          <button id="modeManager" class="active">Manager</button>
          <button id="modeTech">Tech</button>
        </div>
      </div>
      <div class="progress"><div class="bar" id="bar"></div></div>
    </div>

    <div class="banner" id="banner" style="display:none"></div>

    <div class="container">
      <div class="tabs" id="tabs">
        <button class="tab active" data-tab="summary">ğŸ’° Business Impact</button>
        <button class="tab" data-tab="compliance">âš–ï¸ Compliance</button>
        <button class="tab" data-tab="issues">ğŸ”§ Probleme & Fixes</button>
        <button class="tab" data-tab="history">ğŸ“œ Scan-History</button>
        <button class="tab" data-tab="evidence">ğŸ“Š Technische Details</button>
        <button id="exportPDFBtn" class="btn" style="margin-left:auto">ğŸ“¥ PDF Export</button>
      </div>

      <!-- SUMMARY -->
      <section id="tab-summary" class="grid">
        <div class="card">
          <div class="row" style="justify-content:space-between;gap:12px">
            <div class="row">
              <span class="badge" id="scannedUrl">â€“</span>
              <span class="badge" id="timestamp">â€“</span>
              <span class="badge" id="version">vâ€“</span>
            </div>
            <div class="row">
              <span class="badge">3-Session-Test</span>
              <span class="badge">Consent Mode Check</span>
            </div>
          </div>
        </div>

        <!-- Enhanced Dashboard -->
        <div class="results-dashboard">
          <div class="metric-card money">
            <div class="metric-icon">ğŸ’¸</div>
            <div class="metric-value" id="monthlyLoss">â‚¬0</div>
            <div class="metric-label">Monatlicher Verlust</div>
            <div class="metric-trend" id="monthlyTrend">Durch blockierte Conversions</div>
          </div>
          <div class="metric-card critical">
            <div class="metric-icon">ğŸš¨</div>
            <div class="metric-value" id="kpiCritical">0</div>
            <div class="metric-label">Kritische Probleme</div>
            <div class="metric-trend">Sofort behebbar</div>
          </div>
          <div class="metric-card warning">
            <div class="metric-icon">âš ï¸</div>
            <div class="metric-value" id="kpiPerfect">0</div>
            <div class="metric-label">Compliance: OK</div>
            <div class="metric-trend">DSGVO-konform</div>
          </div>
          <div class="metric-card info">
            <div class="metric-icon">ğŸ“ˆ</div>
            <div class="metric-value" id="kpiRisk">0</div>
            <div class="metric-label">Compliance: Risiko</div>
            <div class="metric-trend">Rechtliches Risiko</div>
          </div>
        </div>

        <div class="card">
          <div id="riskBox" class="risk ghost"><strong>Risiko-Bewertung</strong><div id="riskText" class="ghost">â€“</div></div>
        </div>
      </section>

      <!-- COMPLIANCE -->
      <section id="tab-compliance" class="grid" style="display:none">
        <div class="card">
          <div class="toolbar">
            <span class="pill active" data-cflt="all">Alle</span>
            <span class="pill" data-cflt="perfect">Perfekt</span>
            <span class="pill" data-cflt="good">EingeschrÃ¤nkt</span>
            <span class="pill" data-cflt="inconsistent">Uneinheitlich</span>
            <span class="pill" data-cflt="bad">Missachtet</span>
            <span class="pill" data-cflt="missing">Fehlt</span>
            <input id="cSearch" placeholder="Suchen (z. B. GA4, Meta, TikTok)"/>
            <div class="right row">
              <button id="expandAllCompliance" class="copy">Alle Ã¶ffnen</button>
              <button id="collapseAllCompliance" class="copy">Alle schlieÃŸen</button>
            </div>
          </div>
          <div class="list" id="complianceList"></div>
        </div>
      </section>

      <!-- ISSUES -->
      <section id="tab-issues" class="grid" style="display:none">
        <div class="card">
          <div class="toolbar">
            <span class="pill active" data-iflt="all">Alle</span>
            <span class="pill" data-iflt="critical">Kritisch</span>
            <span class="pill" data-iflt="high">Hoch</span>
            <span class="pill" data-iflt="medium">Mittel</span>
            <span class="pill" data-iflt="low">Niedrig</span>
            <input id="iSearch" placeholder="Filter (Domain, Meldung, Status)"/>
            <div class="right row">
              <span class="badge" id="issueCount">0 Items</span>
            </div>
          </div>
          <div class="list" id="issueList"></div>
        </div>
      </section>

      <!-- HISTORY -->
      <section id="tab-history" class="grid" style="display:none">
        <div class="card">
          <h3 style="margin:0 0 16px 0">Scan-Statistiken</h3>
          <div id="statsOverview"></div>
        </div>

        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
            <h3 style="margin:0">Scan-Verlauf</h3>
            <button onclick="loadHistory()" class="copy">ğŸ”„ Aktualisieren</button>
          </div>
          <div id="historyList">
            <div class="empty">Lade History...</div>
          </div>
        </div>

        <div class="card">
          <h3 style="margin:0 0 16px 0">Compliance-Ãœbersicht</h3>
          <div class="chart-container">
            <canvas id="complianceChart"></canvas>
          </div>
        </div>

        <div class="card">
          <h3 style="margin:0 0 16px 0">Probleme nach PrioritÃ¤t</h3>
          <div class="chart-container">
            <canvas id="issuesChart"></canvas>
          </div>
        </div>
      </section>

      <!-- EVIDENCE -->
      <section id="tab-evidence" class="grid" style="display:none">
        <div class="card">
          <div class="empty">WÃ¤hle in Compliance oder Issues ein Element aus, um technische Details anzuzeigen.</div>
        </div>
      </section>
    </div>
  </div>

  <!-- Evidence Drawer -->
  <aside id="drawer" class="drawer">
    <header>
      <div class="brand"><span class="dot"></span>Technische Details</div>
      <div class="right" style="margin-left:auto"><button id="drawerClose" class="copy">SchlieÃŸen</button></div>
    </header>
    <main id="drawerBody"></main>
  </aside>

<script>
const CONFIG = {
  mode: 'live',
  features: { modes: true, evidence: true, tests: false, autoDemo: false, copyButtons: true }
};

const scanSteps = [
  { 
    name: 'Session 1: Ohne Consent', 
    duration: 25000, 
    logs: ['ğŸš€ Browser gestartet (Chromium)', 'ğŸ“„ Seite wird geladen...', 'ğŸª Cookie-Banner erkannt', 'âŒ Keine Zustimmung simuliert', 'ğŸ” Netzwerk-Requests Ã¼berwacht', 'ğŸ“Š Google Analytics: Keine Daten gesendet', 'ğŸ“± Meta Pixel: Blockiert durch CSP', 'âœ… Session 1 abgeschlossen'] 
  },
  { 
    name: 'Session 2: Mit Zustimmung', 
    duration: 25000, 
    logs: ['ğŸ”„ Neue Browser-Session', 'âœ… Cookie-Einstellungen: Alle akzeptiert', 'ğŸ¯ Consent-Event ausgelÃ¶st', 'ğŸ“Š Google Analytics: Daten werden gesendet', 'ğŸ“± Meta Pixel: Verbindung hergestellt', 'ğŸ¯ Google Ads: Conversion-Tracking aktiv', 'âœ… Session 2 abgeschlossen'] 
  },
  { 
    name: 'Session 3: Ablehnung', 
    duration: 25000, 
    logs: ['ğŸ”„ Neue Browser-Session', 'âŒ Cookie-Einstellungen: Alle abgelehnt', 'ğŸ›‘ Reject-Event ausgelÃ¶st', 'ğŸ“Š Google Analytics: Korrekt gestoppt', 'ğŸ“± Meta Pixel: Korrekt gestoppt', 'ğŸ›¡ï¸ Datenschutz-konform', 'âœ… Session 3 abgeschlossen'] 
  },
  { 
    name: 'Analyse & Report', 
    duration: 15000, 
    logs: ['ğŸ”¬ Vergleiche Session-Ergebnisse...', 'ğŸ’° Budget-Impact berechnet', 'âš–ï¸ DSGVO-Compliance geprÃ¼ft', 'ğŸš¨ Kritische Probleme: 2 gefunden', 'ğŸ’¡ Handlungsempfehlungen generiert', 'ğŸ“„ Report ist fertig!'] 
  }
];

let MODE = 'manager';
var DATA = null; // Changed to var so dashboard.js can access it
let currentTheme = localStorage.getItem('theme') || 'light';

// Make DATA available globally for dashboard.js
window.DATA = DATA;

// Initialize theme
document.documentElement.setAttribute('data-theme', currentTheme);

// Utility functions
function $(id) { return document.getElementById(id); }
function escapeHtml(s) { return String(s||'').replace(/[&<>\"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;' }[c])); }
function escapeAttr(s) { return escapeHtml(s).replace(/\"/g,'&quot;'); }
function tryHost(u) { try{ return new URL(u).hostname }catch(e){ return u; } }

function showBanner(msg) {
  const banner = $('banner');
  if(!banner) return;
  banner.textContent = msg;
  banner.style.display='block';
  setTimeout(()=> banner.style.display='none', 2500);
}

// Make showBanner available globally for dashboard.js
window.showBanner = showBanner;

// Theme Toggle
function toggleTheme() {
  currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', currentTheme);
  localStorage.setItem('theme', currentTheme);
  
  const toggle = document.querySelector('.theme-toggle');
  toggle.textContent = currentTheme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ“';
}

// Progress tracking
function updateDetailedProgress(stepIndex, stepProgress, currentLog) {
  const totalSteps = scanSteps.length;
  const overallProgress = ((stepIndex + stepProgress) / totalSteps) * 100;
  
  const progressBar = $('mainProgressBar');
  if (progressBar) {
    progressBar.style.width = overallProgress + '%';
  }
  
  const progressText = $('progressText');
  if (progressText) {
    const currentStep = scanSteps[stepIndex];
    progressText.innerHTML = '<div><strong>' + currentStep.name + '</strong></div>' +
      '<div style="font-size: 0.9rem; color: #6b7280; margin-top: 4px;">' + (currentLog || 'Wird verarbeitet...') + '</div>' +
      '<div style="font-size: 0.8rem; color: #9ca3af; margin-top: 2px;">Schritt ' + (stepIndex + 1) + ' von ' + totalSteps + ' (' + Math.round(overallProgress) + '%)</div>';
  }
  
  // Update step indicators
  const stepElements = ['step1', 'step2', 'step3', 'step4'];
  stepElements.forEach(function(stepId, index) {
    const element = $(stepId);
    if (!element) return;
    
    if (index < stepIndex) {
      element.className = 'step completed';
      element.querySelector('.step-icon').textContent = 'âœ“';
    } else if (index === stepIndex) {
      element.className = 'step active';
      element.querySelector('.step-icon').textContent = index + 1;
    } else {
      element.className = 'step pending';
      element.querySelector('.step-icon').textContent = index + 1;
    }
  });
}

function addLogEntry(text, important) {
  const logDiv = $('liveLog');
  if (!logDiv) return;
  
  const entry = document.createElement('div');
  entry.className = important ? 'log-entry important' : 'log-entry';
  entry.textContent = text;
  logDiv.appendChild(entry);
  logDiv.scrollTop = logDiv.scrollHeight;
  
  // Keep only last 10 entries
  const entries = logDiv.querySelectorAll('.log-entry');
  if (entries.length > 10) {
    entries[0].remove();
  }
}

function sleep(ms) {
  return new Promise(function(resolve) { setTimeout(resolve, ms); });
}

// Real scan function with progress
async function startRealScan(url) {
  try {
    addLogEntry('ğŸš€ Scan wird gestartet...', true);
    
    // Simulate progress for user experience
    for (let stepIndex = 0; stepIndex < scanSteps.length; stepIndex++) {
      const step = scanSteps[stepIndex];
      
      addLogEntry('â–¶ï¸ Starte: ' + step.name, true);
      
      for (let logIndex = 0; logIndex < step.logs.length; logIndex++) {
        const progress = logIndex / step.logs.length;
        const currentLog = step.logs[logIndex];
        
        updateDetailedProgress(stepIndex, progress, currentLog);
        addLogEntry(currentLog);
        
        await sleep(step.duration / step.logs.length);
      }
      
      await sleep(500);
    }
    
    // Complete progress
    updateDetailedProgress(3, 1, 'Scan abgeschlossen!');
    addLogEntry('ğŸ‰ Scan erfolgreich abgeschlossen!', true);
    
    // Try actual scan
    try {
      const response = await fetch('/scan', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ url: url })
      });
      
      if (response.ok) {
        const data = await response.json();
        DATA = data;
        window.DATA = DATA;
        console.log('âœ… Scan data received from server');
      } else {
        throw new Error('Server error');
      }
    } catch (e) {
      // Fallback to demo data
      console.log('âš ï¸ Using demo data, server error:', e.message);
      DATA = buildDemoData();
      window.DATA = DATA;
    }

    // Show results
    console.log('=== RENDERING SCAN RESULTS ===');
    console.log('DATA object:', DATA);
    console.log('Summary:', DATA?.summary);
    console.log('Marketing Tags:', DATA?.summary?.marketingTags);
    console.log('Details:', DATA?.details);
    console.log('Errors count:', DATA?.details?.errors?.length);
    console.log('Network Issues count:', DATA?.details?.networkIssues?.length);
    console.log('CSP Violations count:', DATA?.details?.cspViolations?.length);
    console.log('==============================');

    $('scanProgress').classList.remove('active');
    $('heroSection').style.display = 'none';
    $('exampleSection').style.display = 'none';
    $('urgencyBanner').style.display = 'none';
    $('mainApp').style.display = 'block';
    renderAll();
    showBanner('Scan abgeschlossen!');
    
  } catch (error) {
    addLogEntry('âŒ Fehler: ' + error.message, true);
    // Fallback
    setTimeout(function() {
      DATA = buildDemoData();
      window.DATA = DATA;
      $('scanProgress').classList.remove('active');
      $('heroSection').style.display = 'none';
      $('exampleSection').style.display = 'none';
      $('urgencyBanner').style.display = 'none';
      $('mainApp').style.display = 'block';
      renderAll();
      showBanner('Demo-Daten geladen.');
    }, 2000);
  }
}

// Start scan from hero
function startScanFromHero() {
  const url = $('websiteUrl').value;
  if (!url) {
    alert('Bitte gib eine Website-URL ein');
    return;
  }
  
  if (!/^https?:\/\//.test(url)) {
    $('websiteUrl').value = 'https://' + url;
  }
  
  // Hide hero, show progress
  $('heroSection').style.display = 'none';
  $('exampleSection').style.display = 'none';
  $('urgencyBanner').style.display = 'none';
  $('scanProgress').classList.add('active');
  
  // Update URL display
  $('currentUrl').textContent = $('websiteUrl').value;
  
  // Start the actual scan
  startRealScan($('websiteUrl').value);
}

// DEMO DATA
function buildDemoData() {
  const now = new Date().toLocaleString('de-DE');
  return {
    version: '2.4.0',
    scannedUrl: 'https://demo.regukit.de',
    timestamp: now,
    summary: {
      totalIssues: 7,
      highPriorityIssues: 2,
      marketingTags: [
        { name:'Google Analytics 4', property:'hasGA4', compliance:'perfect', impact:'âœ… GA4 respektiert die Einwilligung.', gdprRisk:'none', withoutConsent:false, withAccept:true, withReject:false, businessImpact:'Besucherdaten DSGVO-konform.' },
        { name:'Meta Pixel (Facebook/Instagram)', property:'hasMetaPixel', compliance:'inconsistent', impact:'ğŸ¤” Uneinheitliches Verhalten, teils CSP-Blockaden.', gdprRisk:'medium', withoutConsent:false, withAccept:true, withReject:false, businessImpact:'Social ROI nur teilweise messbar.' },
        { name:'Google Tag Manager', property:'hasGTM', compliance:'perfect', impact:'âœ… Consent default denied vorhanden.', gdprRisk:'none', withoutConsent:true, withAccept:true, withReject:true, businessImpact:'Steuert Tags korrekt nach Einwilligung.' },
        { name:'TikTok Pixel', property:'hasTikTokPixel', compliance:'missing', impact:'âŒ Eingebunden, aber keine DatenÃ¼bertragungen erkannt.', gdprRisk:'none', withoutConsent:false, withAccept:false, withReject:false, businessImpact:'TikTok-Kampagnen nicht messbar.' }
      ]
    },
    details: {
      errors: [
        { type:'Console Error', message:'Content Security Policy blocked Facebook', priority:'high', translation:'SicherheitsÂ­einstellungen blockieren Verbindungen.', techFix:'CSP connect-src um connect.facebook.net erweitern.' }
      ],
      networkIssues: [
        { url:'https://www.facebook.com/tr/?id=12345', method:'GET', resourceType:'fetch', status:0, priority:'high', translation:'Meta Pixel â€“ Social ROI unbekannt.', techFix:'CSP/CORS prÃ¼fen' }
      ],
      cspViolations: [
        { message:'connect-src blocked https://www.facebook.com/tr/?id=12345', priority:'high', techFix:'connect-src https://www.facebook.com zulassen' }
      ]
    },
    evidence: {
      evidence: {
        hasGA4: { nonTechMeaning: 'Misst Besucher ohne Einwilligung zu verletzen.', nonTechFix: 'Consent Mode aktivieren.' },
        hasMetaPixel: { nonTechMeaning: 'Facebook/Instagram Kampagnen messen.', nonTechFix: 'Pixel nur nach Einwilligung auslÃ¶sen.' }
      }
    }
  };
}

// Render functions
function renderSummary() {
  console.log('ğŸ”µ renderSummary() called');
  if (!DATA) {
    console.log('âŒ No DATA in renderSummary');
    return;
  }

  $('scannedUrl').textContent = DATA.scannedUrl || 'â€“';
  $('timestamp').textContent = DATA.timestamp || 'â€“';
  $('version').textContent = 'v' + (DATA.version || 'â€“');

  // FIXED: Better metric calculation that includes ALL issues
  const allErrors = DATA.details?.errors || [];
  const allNetworkIssues = DATA.details?.networkIssues || [];
  const allCspViolations = DATA.details?.cspViolations || [];
  const mtags = DATA.summary?.marketingTags || [];

  // Count critical issues across ALL categories
  const criticalErrors = allErrors.filter(function(e) { return /critical/i.test(e.priority || ''); }).length;
  const highErrors = allErrors.filter(function(e) { return /high/i.test(e.priority || ''); }).length;
  const criticalNetwork = allNetworkIssues.filter(function(e) { return /critical/i.test(e.priority || ''); }).length;
  const crit = criticalErrors + highErrors + criticalNetwork;

  // Total issues count
  const total = allErrors.length + allNetworkIssues.length + allCspViolations.length;

  // Compliance metrics
  const perfect = mtags.filter(function(m) { return m.compliance === 'perfect'; }).length;
  const badCompliance = mtags.filter(function(m) { return ['bad', 'inconsistent', 'missing'].includes(m.compliance); }).length;
  const risk = badCompliance;

  console.log('ğŸ“Š Summary stats: total=' + total + ', crit=' + crit + ', mtags=' + mtags.length + ', perfect=' + perfect + ', risk=' + risk);

  // FIXED: More realistic money impact calculation
  let monthlyLoss = 0;

  // Critical issues: â‚¬800 each (high impact)
  monthlyLoss += crit * 800;

  // Bad compliance tags: â‚¬500 each (GDPR fines + lost conversions)
  monthlyLoss += badCompliance * 500;

  // General issues: â‚¬150 each (minor impact)
  monthlyLoss += Math.max(0, total - crit) * 150;

  $('monthlyLoss').textContent = 'â‚¬' + monthlyLoss.toLocaleString();
  $('kpiCritical').textContent = crit;
  $('kpiPerfect').textContent = perfect;
  $('kpiRisk').textContent = risk;
  
  const riskBox = $('riskBox');
  const riskText = $('riskText');
  let level = 'low';
  let text = 'Niedriges Risiko â€“ keine kritischen Befunde';
  
  if (crit > 0) { 
    level = 'high'; 
    text = 'Hohes Risiko â€“ kritische Probleme gefunden.'; 
  } else if (total > 0) { 
    level = 'med'; 
    text = 'Mittleres Risiko â€“ einige Probleme erfordern Aufmerksamkeit.'; 
  }
  
  riskBox.className = 'risk ' + level;
  riskText.textContent = text;
  riskBox.classList.remove('ghost');
  riskText.classList.remove('ghost');
}

function renderCompliance() {
  console.log('ğŸ”µ renderCompliance() called');
  const container = $('complianceList');
  if (!container) {
    console.log('âŒ complianceList container not found!');
    return;
  }

  const mtags = DATA.summary?.marketingTags || [];
  console.log('ğŸ“Š Marketing tags to render:', mtags.length, mtags);

  if (mtags.length === 0) {
    console.log('âš ï¸ No marketing tags, showing empty message');
    container.innerHTML = '<div class="empty">Keine Marketing-Tags gefunden</div>';
    return;
  }

  const html = mtags.map(function(tag) {
    const compClass = tag.compliance || 'unknown';
    const compLabel = {
      'perfect': 'Perfekt',
      'good': 'EingeschrÃ¤nkt',
      'inconsistent': 'Uneinheitlich',
      'bad': 'Missachtet',
      'missing': 'Fehlt'
    }[compClass] || 'Unbekannt';

    const riskClass = tag.gdprRisk || 'none';
    const riskLabel = {
      'high': 'âš ï¸ Hoch',
      'medium': 'ğŸŸ¡ Mittel',
      'low': 'ğŸ”µ Niedrig',
      'none': 'âœ… Kein'
    }[riskClass] || 'â€“';

    return '<div class="compliance-item">' +
      '<div class="compliance-header">' +
        '<div class="compliance-name">' + escapeHtml(tag.name) + '</div>' +
        '<div class="compliance-badge badge-' + compClass + '">' + compLabel + '</div>' +
      '</div>' +
      '<div class="compliance-body">' +
        '<div class="compliance-impact">' + escapeHtml(tag.impact || 'Keine Details') + '</div>' +
        '<div class="compliance-meta">' +
          '<span>DSGVO-Risiko: ' + riskLabel + '</span>' +
          '<span>Business Impact: ' + escapeHtml(tag.businessImpact || 'â€“') + '</span>' +
        '</div>' +
        '<div class="compliance-states">' +
          '<span>Ohne Consent: ' + (tag.withoutConsent ? 'ğŸ”´ Aktiv' : 'âœ… Inaktiv') + '</span>' +
          '<span>Mit Accept: ' + (tag.withAccept ? 'âœ… Aktiv' : 'ğŸ”´ Inaktiv') + '</span>' +
          '<span>Mit Reject: ' + (tag.withReject ? 'ğŸ”´ Aktiv' : 'âœ… Inaktiv') + '</span>' +
        '</div>' +
      '</div>' +
    '</div>';
  }).join('');

  container.innerHTML = html;
  console.log('âœ… Compliance HTML rendered, length:', html.length);
}

function renderIssues() {
  console.log('ğŸ”µ renderIssues() called');
  const container = $('issueList');
  if (!container) {
    console.log('âŒ issueList container not found!');
    return;
  }

  const allIssues = [
    ...(DATA.details?.errors || []),
    ...(DATA.details?.networkIssues || []),
    ...(DATA.details?.cspViolations || [])
  ];
  console.log('ğŸš¨ Issues to render:', allIssues.length, 'raw issues');

  if (allIssues.length === 0) {
    console.log('âœ… No issues, showing success message');
    container.innerHTML = '<div class="empty">âœ… Keine Probleme gefunden!</div>';
    return;
  }

  // FIXED: Group and deduplicate issues for better readability
  const groupedIssues = {};

  allIssues.forEach(function(issue) {
    // Extract URL from message if present
    const urlMatch = issue.message ? issue.message.match(/https?:\/\/[^\s]+/) : null;
    const url = urlMatch ? urlMatch[0].replace(/['"]+$/, '') : null;

    // Extract DOMAIN only (not full path) for better grouping
    // Example: https://eu-data.kameleoon.eu/geolocation â†’ eu-data.kameleoon.eu
    let domain = 'no-url';
    if (url) {
      domain = url.replace(/https?:\/\//, '').split('/')[0].split('?')[0];
    }

    // Create a unique key based on translation + DOMAIN (not full URL)
    // This groups all errors for the same domain together
    const key = (issue.translation || issue.message || 'Unknown') + '||' + domain;

    if (!groupedIssues[key]) {
      groupedIssues[key] = {
        translation: issue.translation || issue.message,
        techFix: issue.techFix || issue.managerFix,
        managerFix: issue.managerFix,
        priority: issue.priority || 'low',
        type: issue.type || 'Issue',
        domain: domain, // Store domain instead of full URL
        modes: new Set(),
        count: 0,
        technicalDetails: []
      };
    }

    groupedIssues[key].count++;
    if (issue.consentMode) groupedIssues[key].modes.add(issue.consentMode);
    groupedIssues[key].technicalDetails.push(issue.message);

    // Keep highest priority
    const priorities = ['critical', 'high', 'medium', 'low'];
    if (priorities.indexOf(issue.priority) < priorities.indexOf(groupedIssues[key].priority)) {
      groupedIssues[key].priority = issue.priority;
    }
  });

  const uniqueIssues = Object.values(groupedIssues);
  console.log('ğŸ“Š Grouped to', uniqueIssues.length, 'unique issues');

  // Sort by priority
  uniqueIssues.sort(function(a, b) {
    const priorities = ['critical', 'high', 'medium', 'low'];
    return priorities.indexOf(a.priority) - priorities.indexOf(b.priority);
  });

  const html = uniqueIssues.map(function(issue) {
    const priorityLabel = {
      'critical': 'ğŸ”´ Kritisch',
      'high': 'ğŸŸ  Hoch',
      'medium': 'ğŸŸ¡ Mittel',
      'low': 'ğŸ”µ Niedrig'
    }[issue.priority] || 'â€“';

    const countBadge = issue.count > 1 ? '<span class="issue-count">' + issue.count + 'Ã—</span>' : '';
    const modesText = Array.from(issue.modes).join(', ') || 'â€“';

    // Manager-friendly description
    const managerDesc = MODE === 'manager' && issue.managerFix
      ? '<div class="issue-manager-fix"><strong>Handlungsempfehlung:</strong> ' + escapeHtml(issue.managerFix) + '</div>'
      : '';

    // Display domain (already extracted during grouping)
    let urlDisplay = '';
    if (issue.domain && issue.domain !== 'no-url') {
      urlDisplay = '<div class="issue-url"><strong>ğŸ”— Betroffen:</strong> <code>' + escapeHtml(issue.domain) + '</code></div>';
    }

    return '<div class="issue-item priority-' + issue.priority + '">' +
      '<div class="issue-header">' +
        '<div class="issue-type">' + escapeHtml(issue.type) + ' ' + countBadge + '</div>' +
        '<div class="issue-priority">' + priorityLabel + '</div>' +
      '</div>' +
      '<div class="issue-body">' +
        '<div class="issue-translation"><strong>' + escapeHtml(issue.translation) + '</strong></div>' +
        urlDisplay +
        managerDesc +
        (MODE === 'tech' ? '<div class="issue-fix"><strong>Technischer Fix:</strong> ' + escapeHtml(issue.techFix || 'Keine Empfehlung') + '</div>' : '') +
        '<div class="issue-meta">' +
          '<span><strong>Modi:</strong> ' + escapeHtml(modesText) + '</span>' +
          (issue.count > 1 ? '<span><strong>Vorkommen:</strong> ' + issue.count + '</span>' : '') +
        '</div>' +
      '</div>' +
    '</div>';
  }).join('');

  container.innerHTML = html;
  console.log('âœ… Issues HTML rendered:', uniqueIssues.length, 'unique issues');
}

function renderAll() {
  console.log('ğŸ¨ renderAll() called');
  if (!DATA) {
    console.log('âŒ No DATA object available!');
    return;
  }
  console.log('âœ… DATA object exists, rendering all sections...');
  renderSummary();
  renderCompliance();
  renderIssues();

  // Make sure tabs are visible after rendering
  const complianceTab = $('tab-compliance');
  const issuesTab = $('tab-issues');
  if (complianceTab) {
    complianceTab.style.display = 'grid';
    console.log('âœ… Compliance tab made visible');
  }
  if (issuesTab) {
    issuesTab.style.display = 'grid';
    console.log('âœ… Issues tab made visible');
  }

  console.log('âœ… All render functions completed');
}

// Event handlers
document.addEventListener('DOMContentLoaded', function() {
  // Hero input enter key
  const websiteUrl = $('websiteUrl');
  if (websiteUrl) {
    websiteUrl.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        startScanFromHero();
      }
    });
  }

  // Demo button
  const demoBtn = $('demoBtn');
  if (demoBtn) {
    demoBtn.addEventListener('click', function() {
      DATA = buildDemoData();
      window.DATA = DATA;
      renderAll();
      showBanner('Demo-Daten geladen.');
    });
  }

  // Scan button - FIXED: Now shows immediate loading feedback
  const scanBtn = $('scanBtn');
  if (scanBtn) {
    scanBtn.addEventListener('click', function() {
      const url = $('url').value.trim();
      if (url) {
        // Immediate visual feedback
        scanBtn.disabled = true;
        const originalText = scanBtn.textContent;
        scanBtn.textContent = 'â³ Scan wird gestartet...';

        // Show progress overlay immediately
        const progressOverlay = $('scanProgress');
        const heroSection = $('heroSection');
        const mainApp = $('mainApp');

        if (progressOverlay) progressOverlay.classList.add('active');
        if (heroSection) heroSection.style.display = 'none';
        if (mainApp) mainApp.style.display = 'none';

        console.log('âœ… Starting scan with loading indicator');

        // Start the actual scan
        startRealScan(url).finally(function() {
          // Re-enable button when scan completes or fails
          scanBtn.disabled = false;
          scanBtn.textContent = originalText;
        });
      } else {
        showBanner('âŒ Bitte URL eingeben');
      }
    });
  }

  // Tab switching
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('tab')) {
      // Remove active from all tabs
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));

      // Hide all tab sections
      document.querySelectorAll('#tab-summary, #tab-compliance, #tab-issues, #tab-history, #tab-evidence').forEach(section => {
        section.style.display = 'none';
      });

      // Activate clicked tab
      e.target.classList.add('active');
      const tabId = e.target.getAttribute('data-tab');
      const section = document.getElementById('tab-' + tabId);
      if (section) {
        section.style.display = 'grid';
        console.log('âœ… Switched to tab:', tabId);
      }
    }
  });

  // Mode toggle - FIXED: Now re-renders after mode change
  const modeManager = $('modeManager');
  const modeTech = $('modeTech');

  if (modeManager) {
    modeManager.addEventListener('click', function() {
      MODE = 'manager';
      modeManager.classList.add('active');
      if (modeTech) modeTech.classList.remove('active');
      renderAll(); // Re-render to update view
      console.log('âœ… Switched to Manager view');
    });
  }

  if (modeTech) {
    modeTech.addEventListener('click', function() {
      MODE = 'tech';
      modeTech.classList.add('active');
      if (modeManager) modeManager.classList.remove('active');
      renderAll(); // Re-render to update view
      console.log('âœ… Switched to Tech view');
    });
  }

  // Expand/Collapse All Compliance - NEW
  const expandAllBtn = $('expandAllCompliance');
  const collapseAllBtn = $('collapseAllCompliance');

  if (expandAllBtn) {
    expandAllBtn.addEventListener('click', function() {
      document.querySelectorAll('#complianceList .compliance-item').forEach(item => {
        item.classList.add('expanded');
        const body = item.querySelector('.compliance-body');
        if (body) body.style.display = 'block';
      });
      console.log('âœ… Expanded all compliance items');
    });
  }

  if (collapseAllBtn) {
    collapseAllBtn.addEventListener('click', function() {
      document.querySelectorAll('#complianceList .compliance-item').forEach(item => {
        item.classList.remove('expanded');
        const body = item.querySelector('.compliance-body');
        if (body) body.style.display = 'none';
      });
      console.log('âœ… Collapsed all compliance items');
    });
  }

  // Drawer functionality - NEW
  const drawer = $('drawer');
  const drawerClose = $('drawerClose');

  // Close drawer button
  if (drawerClose) {
    drawerClose.addEventListener('click', function() {
      if (drawer) drawer.classList.remove('open');
      console.log('âœ… Closed drawer');
    });
  }

  // Filter Pills - Compliance - NEW
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('pill') && e.target.hasAttribute('data-cflt')) {
      const filter = e.target.getAttribute('data-cflt');

      // Update active pill
      document.querySelectorAll('[data-cflt]').forEach(pill => pill.classList.remove('active'));
      e.target.classList.add('active');

      // Filter compliance items
      const items = document.querySelectorAll('#complianceList .compliance-item');
      items.forEach(item => {
        if (filter === 'all') {
          item.style.display = 'block';
        } else {
          const badge = item.querySelector('.compliance-badge');
          const hasClass = badge && badge.classList.contains('badge-' + filter);
          item.style.display = hasClass ? 'block' : 'none';
        }
      });

      console.log('âœ… Filtered compliance by:', filter);
    }

    // Filter Pills - Issues - NEW
    if (e.target.classList.contains('pill') && e.target.hasAttribute('data-iflt')) {
      const filter = e.target.getAttribute('data-iflt');

      // Update active pill
      document.querySelectorAll('[data-iflt]').forEach(pill => pill.classList.remove('active'));
      e.target.classList.add('active');

      // Filter issue items
      const items = document.querySelectorAll('#issuesList .issue-item');
      items.forEach(item => {
        if (filter === 'all') {
          item.style.display = 'block';
        } else {
          const hasClass = item.classList.contains('priority-' + filter);
          item.style.display = hasClass ? 'block' : 'none';
        }
      });

      console.log('âœ… Filtered issues by:', filter);
    }

    // Click on compliance items to open drawer
    const complianceItem = e.target.closest('.compliance-item');
    if (complianceItem) {
      const name = complianceItem.querySelector('.compliance-name')?.textContent || 'Details';
      const status = complianceItem.querySelector('.compliance-badge')?.textContent || 'Unknown';
      const body = complianceItem.querySelector('.compliance-body')?.innerHTML || '<p>Keine Details verfÃ¼gbar</p>';

      if (drawer) {
        const drawerBody = $('drawerBody');
        if (drawerBody) {
          drawerBody.innerHTML = `
            <h3>${name}</h3>
            <div class="badge" style="margin-bottom: 16px;">${status}</div>
            ${body}
          `;
        }
        drawer.classList.add('open');
        console.log('âœ… Opened drawer for:', name);
      }
    }

    // Click on issue items to open drawer
    const issueItem = e.target.closest('.issue-item');
    if (issueItem) {
      const type = issueItem.querySelector('.issue-type')?.textContent || 'Issue Details';
      const priority = issueItem.querySelector('.issue-priority')?.textContent || 'Unknown';
      const description = issueItem.querySelector('.issue-description')?.textContent || 'Keine Beschreibung verfÃ¼gbar';

      if (drawer) {
        const drawerBody = $('drawerBody');
        if (drawerBody) {
          drawerBody.innerHTML = `
            <h3>${type}</h3>
            <div class="badge" style="margin-bottom: 16px;">${priority}</div>
            <p>${description}</p>
          `;
        }
        drawer.classList.add('open');
        console.log('âœ… Opened drawer for issue:', type);
      }
    }
  });

  // PDF Export - FIXED: Add event listener here to ensure button exists
  const exportPDFBtn = $('exportPDFBtn');
  if (exportPDFBtn) {
    exportPDFBtn.addEventListener('click', function() {
      console.log('ğŸ” PDF Export button clicked');

      if (!DATA) {
        showBanner('âŒ Keine Scan-Daten zum Exportieren');
        console.log('âŒ No DATA available for PDF export');
        return;
      }

      // Call the exportCurrentScanPDF function from dashboard.js
      if (typeof window.exportCurrentScanPDF === 'function') {
        console.log('âœ… Calling exportCurrentScanPDF()');
        window.exportCurrentScanPDF();
      } else {
        console.log('âš ï¸ exportCurrentScanPDF not available, using fallback');
        showBanner('PDF wird erstellt...');

        fetch('/api/export/pdf', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ scanData: DATA })
        })
        .then(function(response) {
          if (!response.ok) throw new Error('PDF generation failed');
          return response.blob();
        })
        .then(function(blob) {
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'scan-report-' + Date.now() + '.pdf';
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
          showBanner('âœ… PDF heruntergeladen!');
          console.log('âœ… PDF downloaded successfully');
        })
        .catch(function(error) {
          console.error('âŒ PDF export failed:', error);
          showBanner('âŒ PDF-Export fehlgeschlagen');
        });
      }
    });
    console.log('âœ… PDF Export button event listener attached');
  } else {
    console.log('âš ï¸ PDF Export button not found');
  }

  // Focus URL input
  setTimeout(function() {
    if (websiteUrl) websiteUrl.focus();
  }, 300);

  // Initialize theme toggle
  const themeToggle = document.querySelector('.theme-toggle');
  if (themeToggle) {
    themeToggle.textContent = currentTheme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ“';
  }
});
</script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<!-- Enhanced Dashboard Features -->
<script src="/dashboard.js"></script>

</body>
</html>
