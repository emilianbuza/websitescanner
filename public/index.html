<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üí∏ Verlieren Sie t√§glich ‚Ç¨127 durch kaputtes Tracking? | Website Scanner</title>
<style>
  :root{
    --bg:#ffffff; --panel:#f9fafb; --ink:#111827; --muted:#374151;
    --brand:#7c3aed; --brand2:#22c55e; --warn:#d97706; --bad:#b91c1c; --ok:#059669;
    --chip:#f3f4f6; --border:#d1d5db;
  }
  
  [data-theme="dark"] {
    --bg: #1a202c; --panel: #2d3748; --ink: #f7fafc; --muted: #a0aec0;
    --chip: #4a5568; --border: #4a5568;
  }
  
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink);line-height:1.6;transition:all 0.3s ease;}
  a{color:inherit;text-decoration:none}
  
  /* Theme Toggle */
  .theme-toggle {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--brand);
    border: none;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    color: white;
    cursor: pointer;
    z-index: 1000;
    font-size: 1.2rem;
    transition: all 0.3s ease;
  }
  .theme-toggle:hover {
    transform: scale(1.1);
  }
  
  /* Hero Section */
  .hero-section{background:linear-gradient(135deg,#f0f7ff 0%,#e0f2fe 100%);padding:80px 0;text-align:center;margin-bottom:30px}
  .hero-section h1{font-size:3.5rem;font-weight:800;margin:0 0 20px 0;color:#1f2937}
  .hero-section .subtitle{font-size:1.4rem;color:#4b5563;margin-bottom:40px;max-width:800px;margin-left:auto;margin-right:auto}
  .cta-enhanced{max-width:600px;margin:0 auto 40px auto;background:white;padding:25px;border-radius:12px;box-shadow:0 8px 16px rgba(0,0,0,0.1)}
  .cta-enhanced input{width:100%;padding:16px 20px;border:2px solid #e5e7eb;border-radius:8px;font-size:1.1rem;margin-bottom:15px}
  .cta-enhanced input:focus{outline:none;border-color:var(--brand)}
  .cta-enhanced button{width:100%;background:var(--brand);color:white;border:none;padding:16px 24px;border-radius:8px;font-size:1.1rem;font-weight:600;cursor:pointer}
  .cta-enhanced button:hover{background:#6d28d9}
  .trust-signals{display:flex;justify-content:center;gap:20px;margin-top:15px;font-size:0.9rem;color:#059669}
  .trust-signals span{display:flex;align-items:center;gap:5px}
  
  /* Urgency Banner */
  .urgency-banner {
    background: #fee2e2;
    border: 2px solid #dc2626;
    padding: 20px;
    margin: 20px;
    border-radius: 12px;
    text-align: center;
    animation: pulse-urgency 3s infinite;
  }
  .urgency-banner h3 {
    color: #dc2626;
    margin: 0 0 10px 0;
  }
  .urgency-banner p {
    margin: 0;
    font-size: 1.1rem;
  }
  @keyframes pulse-urgency {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.02); }
  }
  
  /* Problem Examples */
  .example-findings{margin:60px 0;padding:0 20px}
  .example-findings h3{text-align:center;font-size:1.8rem;margin-bottom:30px;color:#1f2937}
  .problem-examples{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;max-width:1200px;margin:0 auto}
  .problem{background:white;border-left:4px solid #ef4444;padding:20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);transition:all 0.3s ease;cursor:pointer}
  .problem:hover{transform:translateY(-4px);box-shadow:0 8px 20px rgba(0,0,0,0.15)}
  .problem-icon{font-size:1.2rem;margin-bottom:10px}
  .problem-title{font-weight:600;color:#1f2937;margin-bottom:8px}
  .problem-impact{color:#6b7280;font-size:0.9rem}
  
  /* Enhanced Progress Bar */
  .scan-progress{background:white;border:2px solid var(--brand);border-radius:12px;padding:25px;margin:20px auto;max-width:700px;display:none;box-shadow:0 8px 16px rgba(0,0,0,0.1)}
  .scan-progress.active{display:block}
  .progress-header{text-align:center;margin-bottom:20px}
  .progress-header h3{margin:0 0 10px 0;color:#1f2937;font-size:1.5rem}
  .estimated-time{font-size:0.9rem;color:#6b7280}
  
  .progress-milestones{display:flex;justify-content:space-between;margin-bottom:25px;position:relative}
  .progress-milestones::before{content:'';position:absolute;top:15px;left:15px;right:15px;height:2px;background:#e5e7eb;z-index:1}
  .milestone{text-align:center;position:relative;z-index:2}
  .milestone-dot{width:30px;height:30px;border-radius:50%;margin:0 auto 8px;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:0.8rem}
  .milestone.completed .milestone-dot{background:#22c55e;color:white}
  .milestone.active .milestone-dot{background:#7c3aed;color:white;animation:pulse 2s infinite}
  .milestone.pending .milestone-dot{background:#e5e7eb;color:#9ca3af}
  .milestone-label{font-size:0.8rem;color:#6b7280}
  
  .main-progress{margin-bottom:25px}
  .progress-bar{height:8px;background:#e5e7eb;border-radius:4px;overflow:hidden;margin-bottom:10px}
  .progress-fill{height:100%;background:linear-gradient(90deg,var(--brand),var(--brand2));transition:width 0.3s ease;width:0%}
  .progress-text{font-size:14px;color:#6b7280;text-align:center}
  
  .live-scanning-visualization{position:relative;height:60px;background:#f8fafc;border-radius:8px;overflow:hidden;margin-top:20px}
  .scanning-line{position:absolute;top:0;left:0;width:4px;height:100%;background:linear-gradient(to bottom,#7c3aed,#22c55e);animation:scan-sweep 3s ease-in-out infinite}
  @keyframes scan-sweep{0%,100%{left:0}50%{left:calc(100% - 4px)}}
  .data-points{position:absolute;top:50%;left:20px;right:20px;height:2px}
  .data-point{position:absolute;width:8px;height:8px;background:#ef4444;border-radius:50%;animation:data-pulse 2s ease-in-out infinite}
  @keyframes data-pulse{0%,100%{opacity:0;transform:scale(0.5)}50%{opacity:1;transform:scale(1)}}
  
  .scan-steps{margin-top:20px}
  .step{display:flex;align-items:center;padding:12px 0;border-left:3px solid transparent;padding-left:15px;margin-left:10px;border-radius:0 8px 8px 0;transition:all 0.3s ease}
  .step.completed{border-color:#22c55e;background:#f0f9f4}
  .step.active{border-color:#7c3aed;background:#f3f4f6;animation:pulse 2s infinite}
  .step.pending{border-color:#e5e7eb;color:#9ca3af}
  .step-icon{width:20px;height:20px;margin-right:12px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:600}
  .step.completed .step-icon{background:#22c55e;color:white}
  .step.active .step-icon{background:#7c3aed;color:white}
  .step.pending .step-icon{background:#e5e7eb;color:#9ca3af}
  .step-text{flex:1}
  .step-duration{font-size:12px;color:#6b7280;margin-top:2px}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.7}}
  .live-log{margin-top:20px;background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:15px;max-height:150px;overflow-y:auto}
  .live-log h4{margin:0 0 10px 0;font-size:14px;color:#374151}
  .log-entry{font-family:monospace;font-size:12px;margin:2px 0;color:#6b7280;padding:2px 0}
  .log-entry.important{color:#7c3aed;font-weight:600}
  
  /* Dashboard Style Results */
  .results-dashboard {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin: 20px 0;
  }
  
  .metric-card {
    background: linear-gradient(135deg, #fff 0%, #f8fafc 100%);
    border-radius: 16px;
    padding: 24px;
    text-align: center;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }
  
  .metric-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
  }
  
  .metric-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
  }
  
  .metric-card.critical::before { background: #ef4444; }
  .metric-card.warning::before { background: #f59e0b; }
  .metric-card.info::before { background: #10b981; }
  .metric-card.money::before { background: linear-gradient(90deg, #ef4444, #f59e0b); }
  
  .metric-icon {
    font-size: 2rem;
    margin-bottom: 10px;
  }
  
  .metric-value {
    font-size: 2.5rem;
    font-weight: bold;
    color: #1a202c;
    margin-bottom: 5px;
  }
  
  .metric-label {
    color: #6b7280;
    font-size: 0.9rem;
  }
  
  .metric-trend {
    font-size: 0.8rem;
    color: #10b981;
    margin-top: 5px;
  }
  
  /* Enhanced Problem Cards */
  .problem-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin: 10px 0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    cursor: pointer;
    border-left: 4px solid #e2e8f0;
    position: relative;
    overflow: hidden;
  }
  
  .problem-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
  }
  
  .problem-card.critical {
    border-left-color: #ef4444;
    background: linear-gradient(135deg, #fff 0%, #fef2f2 100%);
  }
  
  .problem-card.warning {
    border-left-color: #f59e0b;
    background: linear-gradient(135deg, #fff 0%, #fefbeb 100%);
  }
  
  .problem-card.info {
    border-left-color: #10b981;
    background: linear-gradient(135deg, #fff 0%, #f0f9f4 100%);
  }
  
  .problem-header {
    display: flex;
    align-items: center;
    margin-bottom: 12px;
  }
  
  .problem-severity {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 10px;
  }
  
  .severity-critical { background: #ef4444; }
  .severity-warning { background: #f59e0b; }
  .severity-info { background: #10b981; }
  
  /* Fix Section */
  .fix-section {
    margin-top: 15px;
    padding: 15px;
    background: #f8fafc;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
  }
  
  .fix-section h5 {
    margin: 0 0 10px 0;
    color: #374151;
  }
  
  .code-block {
    background: #1a202c;
    color: #f7fafc;
    padding: 12px;
    border-radius: 6px;
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
    overflow-x: auto;
    margin: 10px 0;
  }
  
  .copy-btn {
    background: #10b981;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: all 0.3s ease;
  }
  
  .copy-btn:hover {
    background: #059669;
    transform: translateY(-1px);
  }
  
  .copy-btn.copied {
    background: #22c55e;
  }
  
  /* Smart Filters */
  .smart-filters {
    background: white;
    padding: 20px;
    border-radius: 12px;
    margin: 20px 0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  
  .filter-group {
    margin-bottom: 15px;
  }
  
  .filter-group label {
    font-weight: 600;
    margin-bottom: 10px;
    display: block;
    color: #374151;
  }
  
  .filter-pills {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 15px;
  }
  
  .filter-pill {
    background: #f3f4f6;
    border: 1px solid #d1d5db;
    padding: 8px 16px;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9rem;
  }
  
  .filter-pill:hover {
    background: #e5e7eb;
  }
  
  .filter-pill.active {
    background: var(--brand);
    color: white;
    border-color: var(--brand);
  }
  
  .smart-search {
    position: relative;
  }
  
  .smart-search input {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 1rem;
  }
  
  .smart-search input:focus {
    outline: none;
    border-color: var(--brand);
    box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
  }
  
  /* Export Panel */
  .export-panel {
    background: white;
    padding: 20px;
    border-radius: 12px;
    margin: 20px 0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  
  .export-panel h4 {
    margin: 0 0 15px 0;
    color: #374151;
  }
  
  .export-options {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }
  
  .export-btn {
    background: var(--brand);
    color: white;
    border: none;
    padding: 10px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: all 0.3s ease;
  }
  
  .export-btn:hover {
    background: #6d28d9;
    transform: translateY(-1px);
  }
  
  .container{max-width:1200px;margin:0 auto;padding:16px 16px 80px}
  .topbar{position:sticky;top:0;z-index:30;background:var(--bg);border-bottom:1px solid var(--border)}
  .topbar-inner{max-width:1200px;margin:0 auto;display:flex;gap:12px;align-items:center;padding:10px 16px}
  .brand{display:flex;gap:10px;align-items:center;font-weight:700}
  .brand .dot{width:10px;height:10px;border-radius:999px;background:conic-gradient(var(--brand),var(--brand2))}
  .urlfield{flex:1;display:flex;gap:8px}
  .urlfield input{flex:1;background:var(--bg);border:1px solid var(--border);padding:12px 14px;border-radius:10px;color:var(--ink)}
  .btn{background:var(--brand);border:none;color:white;padding:12px 16px;border-radius:10px;font-weight:600;cursor:pointer}
  .btn.alt{background:#e5e7eb;color:#111827}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .toggle{display:flex;gap:6px;border:1px solid var(--border);border-radius:999px;padding:5px;background:#f3f4f6}
  .toggle button{border:none;padding:8px 12px;border-radius:999px;background:transparent;color:var(--ink);cursor:pointer}
  .toggle .active{background:#e5e7eb}
  .progress{height:6px;background:#f3f4f6;border-top:1px solid var(--border)}
  .progress .bar{height:100%;width:0;background:linear-gradient(90deg,var(--brand),var(--brand2));transition:width .4s ease}
  .tabs{display:flex;gap:8px;margin:16px 0}
  .tab{padding:10px 14px;border:1px solid var(--border);border-radius:10px;cursor:pointer;background:#f9fafb;color:var(--muted)}
  .tab.active{background:#e5e7eb;color:var(--ink)}
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:900px){.grid{grid-template-columns:repeat(12,1fr)}}
  .card{grid-column:span 12;background:var(--bg);border:1px solid var(--border);border-radius:14px;padding:16px}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#f3f4f6;border:1px solid var(--border);font-size:.85rem;color:#374151}
  .pill{padding:7px 10px;border-radius:999px;background:#f9fafb;border:1px solid var(--border);cursor:pointer}
  .pill.active{background:#e5e7eb;color:#111827}
  .kpi{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  @media(min-width:900px){.kpi{grid-template-columns:repeat(4,1fr)}}
  .kpicard{background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:14px}
  .kpicard h3{margin:0 0 4px 0;font-size:.9rem;color:#374151}
  .kpicard .val{font-size:1.6rem;font-weight:800}
  .risk{border-radius:12px;padding:16px;border:1px solid var(--border)}
  .risk.low{background:#d1fae5}
  .risk.med{background:#fef3c7}
  .risk.high{background:#fee2e2}
  .list{display:flex;flex-direction:column;gap:8px}
  .item{background:var(--bg);border:1px solid var(--border);border-radius:12px;overflow:hidden}
  .item header{display:flex;gap:10px;align-items:center;padding:12px 14px;cursor:pointer}
  .item header .title{flex:1;font-weight:600}
  .severity{width:10px;height:10px;border-radius:999px}
  .sev-low{background:var(--ok)} .sev-med{background:var(--warn)} .sev-high{background:var(--bad)}
  .meta{display:flex;gap:8px;flex-wrap:wrap}
  .meta .chip{background:#f3f4f6;border:1px solid var(--border);padding:4px 8px;border-radius:999px;font-size:.8rem;color:#374151}
  .body{display:none;border-top:1px solid var(--border);padding:12px 14px}
  .body.open{display:block}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
  .toolbar input{flex:1;min-width:180px;background:var(--bg);border:1px solid var(--border);padding:10px;border-radius:10px;color:var(--ink)}
  .right{margin-left:auto}
  .ghost{opacity:.65}
  .drawer{position:fixed;top:0;right:-520px;width:520px;max-width:100%;height:100%;background:var(--bg);border-left:1px solid var(--border);
          transition:right .3s ease;z-index:50;display:flex;flex-direction:column;color:#111827}
  .drawer.open{right:0}
  .drawer header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;gap:10px;align-items:center}
  .drawer main{padding:16px;overflow:auto;display:flex;flex-direction:column;gap:12px}
  pre{background:#f9fafb;border:1px solid var(--border);border-radius:10px;padding:10px;overflow:auto;white-space:pre-wrap}
  code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
  .copy{background:#e5e7eb;border:1px solid var(--border);color:#111827;border-radius:8px;padding:6px 10px;cursor:pointer}
  .empty{padding:18px;border:1px dashed var(--border);border-radius:12px;color:#6b7280;text-align:center}
  .preview{margin-left:8px;font-size:.85rem;color:#7c3aed}
  .banner{margin:12px auto 0;max-width:1200px;background:#e0f2fe;border:1px solid #93c5fd;color:#1e3a8a;padding:10px 14px;border-radius:10px}
  .test{font-size:.85rem;color:#047857}
  
  @media (max-width: 768px) {
    .hero-section h1 { font-size: 2.5rem; }
    .hero-section .subtitle { font-size: 1.2rem; }
    .trust-signals { flex-direction: column; gap: 10px; }
    .problem-examples { grid-template-columns: 1fr; }
    .cta-enhanced { margin: 0 20px 40px 20px; }
    .results-dashboard { grid-template-columns: 1fr; }
    .export-options { flex-direction: column; }
  }
</style>
</head>
<body>
  <!-- Theme Toggle -->
  <button class="theme-toggle" onclick="toggleTheme()" title="Theme wechseln">üåì</button>

  <!-- Hero Section (Landing Page) -->
  <div id="heroSection" class="hero-section">
    <div style="max-width: 800px; margin: 0 auto; padding: 0 20px;">
      <h1>üí∏ Verlieren Sie t√§glich ‚Ç¨127 durch kaputtes Tracking?</h1>
      <p class="subtitle">
        Unser 60-Sekunden-Scan findet heraus, ob Google Ads, Facebook Pixel & Co. 
        bei Ihnen blockiert sind ‚Äì und Sie dadurch <strong>‚Ç¨1.500-4.800/Monat</strong> verlieren.
      </p>
      
      <div class="cta-enhanced">
        <input type="url" id="websiteUrl" placeholder="https://ihre-website.de">
        <button onclick="startScanFromHero()">Jetzt kostenlos pr√ºfen (60 Sek.)</button>
        <div class="trust-signals">
          <span>‚úÖ √ò ‚Ç¨3.200 Verlust entdeckt</span>
          <span>‚úÖ 89% finden kritische Probleme</span>
          <span>‚úÖ Sofort-L√∂sungen inklusive</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Urgency Banner -->
  <div id="urgencyBanner" class="urgency-banner">
    <h3>‚ö†Ô∏è Achtung: Jeden Tag warten kostet Geld!</h3>
    <p>
      <strong>Durchschnittlich verlieren Websites ‚Ç¨127/Tag</strong> durch blockiertes Tracking.<br>
      <span style="color: #7f1d1d;">Das sind ‚Ç¨3.800/Monat die direkt in Ihre Konkurrenz flie√üen.</span>
    </p>
  </div>

  <!-- Example Problems -->
  <div id="exampleSection" class="example-findings">
    <div style="max-width: 1200px; margin: 0 auto;">
      <h3>H√§ufige Probleme, die wir finden:</h3>
      <div class="problem-examples">
        <div class="problem">
          <div class="problem-icon">üí∏ üìä</div>
          <div class="problem-title">Google Analytics sammelt ohne Erlaubnis</div>
          <div class="problem-impact">‚Ç¨2.000 Abmahn-Risiko + Ihre Zahlen sind rechtlich nutzlos</div>
        </div>
        
        <div class="problem">
          <div class="problem-icon">üí∏ üì±</div>
          <div class="problem-title">Facebook Ads laufen blind</div>
          <div class="problem-impact">‚Ç¨850/Monat verschwendet, weil Conversions nicht gemessen werden</div>
        </div>
        
        <div class="problem">
          <div class="problem-icon">üí∏ üéØ</div>
          <div class="problem-title">Retargeting funktioniert nicht</div>
          <div class="problem-impact">70% weniger Wiederk√§ufer = ‚Ç¨1.200/Monat Umsatzverlust</div>
        </div>
        
        <div class="problem">
          <div class="problem-icon">üí∏ üîí</div>
          <div class="problem-title">Sicherheitsregeln zu streng</div>
          <div class="problem-impact">‚Ç¨450/Monat verloren durch blockierte Marketing-Tools</div>
        </div>
        
        <div class="problem">
          <div class="problem-icon">üí∏ üìà</div>
          <div class="problem-title">TikTok/LinkedIn Pixel stumm</div>
          <div class="problem-impact">Social Media ROI nicht messbar = Blind optimieren</div>
        </div>
        
        <div class="problem">
          <div class="problem-icon">üí∏ üç™</div>
          <div class="problem-title">Consent-Banner funktionslos</div>
          <div class="problem-impact">Tools sammeln trotz "Ablehnen" Daten ‚Äì ‚Ç¨2.000 Abmahn-Risiko</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scan Progress (Hidden initially) -->
  <div class="scan-progress" id="scanProgress">
    <div class="progress-header">
      <h3>Website wird analysiert...</h3>
      <div id="currentUrl" class="badge" style="margin-bottom: 15px;">‚Äì</div>
      <div class="estimated-time">Noch ca. <span id="timeLeft">60</span> Sekunden</div>
    </div>
    
    <div class="progress-milestones">
      <div class="milestone pending" id="milestone1">
        <div class="milestone-dot">1</div>
        <div class="milestone-label">Sicherheit</div>
      </div>
      <div class="milestone pending" id="milestone2">
        <div class="milestone-dot">2</div>
        <div class="milestone-label">Tracking</div>
      </div>
      <div class="milestone pending" id="milestone3">
        <div class="milestone-dot">3</div>
        <div class="milestone-label">Compliance</div>
      </div>
      <div class="milestone pending" id="milestone4">
        <div class="milestone-dot">4</div>
        <div class="milestone-label">Report</div>
      </div>
    </div>
    
    <div class="main-progress">
      <div class="progress-bar">
        <div class="progress-fill" id="mainProgressBar"></div>
      </div>
      <div class="progress-text" id="progressText">Vorbereitung... (0/4 Schritte)</div>
    </div>
    
    <div class="live-scanning-visualization">
      <div class="scanning-line"></div>
      <div class="data-points">
        <div class="data-point" style="left: 20%; animation-delay: 0.5s;"></div>
        <div class="data-point" style="left: 50%; animation-delay: 1s;"></div>
        <div class="data-point" style="left: 80%; animation-delay: 1.5s;"></div>
      </div>
    </div>
    
    <div class="live-log">
      <h4>üîç Live-Details:</h4>
      <div id="liveLog">
        <div class="log-entry">Scanner wird vorbereitet...</div>
      </div>
    </div>
  </div>

  <!-- Main App (Hidden initially) -->
  <div id="mainApp" style="display: none;">
    <div class="topbar">
      <div class="topbar-inner">
        <div class="brand"><span class="dot"></span>Website Scanner <span class="preview">¬∑ Ergebnisse</span></div>
        <div class="urlfield">
          <input id="url" type="url" placeholder="https://ihre-website.de" />
          <button id="scanBtn" class="btn">Erneut scannen</button>
          <button id="demoBtn" class="btn alt">Demo laden</button>
        </div>
        <div class="toggle" title="Darstellung">
          <button id="modeManager" class="active">Manager</button>
          <button id="modeTech">Tech</button>
        </div>
      </div>
      <div class="progress"><div class="bar" id="bar"></div></div>
    </div>

    <div class="banner" id="banner" style="display:none"></div>

    <div class="container">
      <!-- Smart Filters -->
      <div class="smart-filters">
        <div class="filter-group">
          <label>Zeige mir nur:</label>
          <div class="filter-pills">
            <button class="filter-pill active" data-filter="all">Alle Probleme</button>
            <button class="filter-pill" data-filter="money-impact">üí∞ Kostet Geld</button>
            <button class="filter-pill" data-filter="quick-fix">‚ö° Schnell l√∂sbar</button>
            <button class="filter-pill" data-filter="legal-risk">‚öñÔ∏è Rechtliches Risiko</button>
            <button class="filter-pill" data-filter="performance">üöÄ Performance</button>
          </div>
        </div>
        
        <div class="smart-search">
          <input type="text" placeholder="Suche: 'Facebook', 'Google Ads', 'DSGVO'..." 
                 id="smartSearch" oninput="smartFilter(this.value)">
        </div>
      </div>

      <div class="tabs" id="tabs">
        <button class="tab active" data-tab="summary">üí∞ Business Impact</button>
        <button class="tab" data-tab="compliance">‚öñÔ∏è Compliance</button>
        <button class="tab" data-tab="issues">üîß Probleme & Fixes</button>
        <button class="tab" data-tab="evidence">üìä Technische Details</button>
      </div>

      <!-- SUMMARY -->
      <section id="tab-summary" class="grid">
        <div class="card">
          <div class="row" style="justify-content:space-between;gap:12px">
            <div class="row">
              <span class="badge" id="scannedUrl">‚Äì</span>
              <span class="badge" id="timestamp">‚Äì</span>
              <span class="badge" id="version">v‚Äì</span>
            </div>
            <div class="row">
              <span class="badge">3-Session-Test</span>
              <span class="badge">Consent Mode Check</span>
            </div>
          </div>
        </div>

        <!-- Enhanced Dashboard -->
        <div class="results-dashboard">
          <div class="metric-card money">
            <div class="metric-icon">üí∏</div>
            <div class="metric-value" id="monthlyLoss">‚Ç¨0</div>
            <div class="metric-label">Monatlicher Verlust</div>
            <div class="metric-trend" id="monthlyTrend">Durch blockierte Conversions</div>
          </div>
          <div class="metric-card critical">
            <div class="metric-icon">üö®</div>
            <div class="metric-value" id="criticalCount">0</div>
            <div class="metric-label">Kritische Probleme</div>
            <div class="metric-trend">Sofort behebbar</div>
          </div>
          <div class="metric-card warning">
            <div class="metric-icon">‚ö†Ô∏è</div>
            <div class="metric-value" id="legalRisk">‚Ç¨0</div>
            <div class="metric-label">Rechtliches Risiko</div>
            <div class="metric-trend">DSGVO-Verst√∂√üe</div>
          </div>
          <div class="metric-card info">
            <div class="metric-icon">üìà</div>
            <div class="metric-value" id="yearlyLoss">‚Ç¨0</div>
            <div class="metric-label">J√§hrlich verschwendet</div>
            <div class="metric-trend">Hochgerechnet</div>
          </div>
        </div>

        <div class="card">
          <div id="riskBox" class="risk ghost"><strong>Risiko-Bewertung</strong><div id="riskText" class="ghost">‚Äì</div></div>
        </div>

        <!-- Export Options -->
        <div class="export-panel">
          <h4>üìä Report exportieren & teilen</h4>
          <div class="export-options">
            <button onclick="exportResults('pdf')" class="export-btn">üìÑ PDF-Report</button>
            <button onclick="exportResults('csv')" class="export-btn">üìä CSV-Daten</button>
            <button onclick="shareResults()" class="export-btn">üîó Link teilen</button>
            <button onclick="scheduleRescan()" class="export-btn">‚è∞ Monitoring einrichten</button>
          </div>
        </div>
      </section>

      <!-- COMPLIANCE -->
      <section id="tab-compliance" class="grid" style="display:none">
        <div class="card">
          <div class="toolbar">
            <span class="pill active" data-cflt="all">Alle</span>
            <span class="pill" data-cflt="perfect">Perfekt</span>
            <span class="pill" data-cflt="good">Eingeschr√§nkt</span>
            <span class="pill" data-cflt="inconsistent">Uneinheitlich</span>
            <span class="pill" data-cflt="bad">Missachtet</span>
            <span class="pill" data-cflt="missing">Fehlt</span>
            <input id="cSearch" placeholder="Suchen (z. B. GA4, Meta, TikTok)"/>
            <div class="right row">
              <button id="expandAllCompliance" class="copy">Alle √∂ffnen</button>
              <button id="collapseAllCompliance" class="copy">Alle schlie√üen</button>
            </div>
          </div>
          <div class="list" id="complianceList"></div>
        </div>
      </section>

      <!-- ISSUES -->
      <section id="tab-issues" class="grid" style="display:none">
        <div class="card">
          <div class="toolbar">
            <span class="pill active" data-iflt="all">Alle</span>
            <span class="pill" data-iflt="critical">Kritisch</span>
            <span class="pill" data-iflt="high">Hoch</span>
            <span class="pill" data-iflt="medium">Mittel</span>
            <span class="pill" data-iflt="low">Niedrig</span>
            <input id="iSearch" placeholder="Filter (Domain, Meldung, Status)"/>
            <div class="right row">
              <span class="badge" id="issueCount">0 Items</span>
            </div>
          </div>
          <div class="list" id="issueList"></div>
        </div>
      </section>

      <!-- EVIDENCE -->
      <section id="tab-evidence" class="grid" style="display:none">
        <div class="card">
          <div class="empty">W√§hle in Compliance oder Issues ein Element aus, um technische Details anzuzeigen.</div>
        </div>
      </section>
    </div>
  </div>

  <!-- Evidence Drawer -->
  <aside id="drawer" class="drawer">
    <header>
      <div class="brand"><span class="dot"></span>Technische Details</div>
      <div class="right" style="margin-left:auto"><button id="drawerClose" class="copy">Schlie√üen</button></div>
    </header>
    <main id="drawerBody"></main>
  </aside>

<script>
const CONFIG = {
  mode: 'live',
  features: { modes: true, evidence: true, tests: false, autoDemo: false, copyButtons: true }
};

const scanSteps = [
  { 
    name: 'Session 1: Ohne Consent', 
    duration: 20000, 
    logs: ['üöÄ Browser gestartet (Chromium)', 'üìÑ Seite wird geladen...', 'üç™ Cookie-Banner erkannt', '‚ùå Keine Zustimmung simuliert', 'üîç Netzwerk-Requests √ºberwacht', 'üìä Google Analytics: Keine Daten gesendet', 'üì± Meta Pixel: Blockiert durch CSP', '‚úÖ Session 1 abgeschlossen'] 
  },
  { 
    name: 'Session 2: Mit Zustimmung', 
    duration: 20000, 
    logs: ['üîÑ Neue Browser-Session', '‚úÖ Cookie-Einstellungen: Alle akzeptiert', 'üéØ Consent-Event ausgel√∂st', 'üìä Google Analytics: Daten werden gesendet', 'üì± Meta Pixel: Verbindung hergestellt', 'üéØ Google Ads: Conversion-Tracking aktiv', '‚úÖ Session 2 abgeschlossen'] 
  },
  { 
    name: 'Session 3: Ablehnung', 
    duration: 20000, 
    logs: ['üîÑ Neue Browser-Session', '‚ùå Cookie-Einstellungen: Alle abgelehnt', 'üõë Reject-Event ausgel√∂st', 'üìä Google Analytics: Korrekt gestoppt', 'üì± Meta Pixel: Korrekt gestoppt', 'üõ°Ô∏è Datenschutz-konform', '‚úÖ Session 3 abgeschlossen'] 
  },
  { 
    name: 'Analyse & Report', 
    duration: 10000, 
    logs: ['üî¨ Vergleiche Session-Ergebnisse...', 'üí∞ Budget-Impact berechnet', '‚öñÔ∏è DSGVO-Compliance gepr√ºft', 'üö® Kritische Probleme: 3 gefunden', 'üí° Handlungsempfehlungen generiert', 'üìÑ Report ist fertig!'] 
  }
];

let MODE = 'manager';
let DATA = null;
let currentTheme = localStorage.getItem('theme') || 'light';

// Initialize theme
document.documentElement.setAttribute('data-theme', currentTheme);

// Utility functions
function $(id) { return document.getElementById(id); }
function escapeHtml(s) { return String(s||'').replace(/[&<>\"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;' }[c])); }
function escapeAttr(s) { return escapeHtml(s).replace(/\"/g,'&quot;'); }
function tryHost(u) { try{ return new URL(u).hostname }catch(e){ return u; } }

function showBanner(msg) { 
  const banner = $('banner');
  if(!banner) return; 
  banner.textContent = msg; 
  banner.style.display='block'; 
  setTimeout(()=> banner.style.display='none', 3000); 
}

// Theme Toggle
function toggleTheme() {
  currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', currentTheme);
  localStorage.setItem('theme', currentTheme);
  
  const toggle = document.querySelector('.theme-toggle');
  toggle.textContent = currentTheme === 'dark' ? '‚òÄÔ∏è' : 'üåì';
}

// Money Impact Calculator
function calculateMoneyImpact(issues) {
  let monthlyLoss = 0;
  let riskAmount = 0;
  
  // Einfache Berechnung basierend auf gefundenen Problemen
  issues.forEach(issue => {
    const msg = (issue.message || '').toLowerCase();
    
    if (msg.includes('facebook') || msg.includes('meta') || msg.includes('connect.facebook.net')) {
      monthlyLoss += 650; // Facebook Pixel Problem
    }
    if (msg.includes('google-analytics') || msg.includes('analytics')) {
      monthlyLoss += 400; // GA Problem  
    }
    if (msg.includes('googleadservices') || msg.includes('google ads')) {
      monthlyLoss += 850; // Google Ads Problem
    }
    if (msg.includes('tiktok') || msg.includes('analytics.tiktok.com')) {
      monthlyLoss += 300; // TikTok Problem
    }
    if (msg.includes('hotjar')) {
      monthlyLoss += 200; // Hotjar Problem
    }
    
    // DSGVO Risiko
    if (msg.includes('ohne') && (msg.includes('consent') || msg.includes('einwilligung'))) {
      riskAmount += 2000; // Abmahn-Risiko
    }
    if (msg.includes('csp') || msg.includes('security policy')) {
      riskAmount += 500; // Sicherheitsrisiko
    }
  });
  
  return { 
    monthlyLoss: Math.min(monthlyLoss, 4800), // Cap bei 4800‚Ç¨
    riskAmount, 
    yearlyLoss: monthlyLoss * 12 
  };
}

// Copy to Clipboard
function copyToClipboard(text) {
  if (navigator.clipboard) {
    navigator.clipboard.writeText(text).then(() => {
      showBanner('Code kopiert! üìã Jetzt einf√ºgen und testen.');
    });
  } else {
    // Fallback f√ºr √§ltere Browser
    const textarea = document.createElement('textarea');
    textarea.value = text;
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand('copy');
    document.body.removeChild(textarea);
    showBanner('Code kopiert! üìã');
  }
}

// Generate Fix Code
function generateFixCode(findingType, url, issue) {
  const fixes = {
    'csp': `# CSP-Header erweitern (in .htaccess oder Server-Config):
Header always set Content-Security-Policy "script-src 'self' 'unsafe-inline' https://*.google.com https://*.facebook.com https://*.googletagmanager.com https://*.tiktok.com; connect-src 'self' https://*.google-analytics.com https://*.facebook.com https://*.doubleclick.net;"

# Oder f√ºr Nginx:
add_header Content-Security-Policy "script-src 'self' 'unsafe-inline' https://*.google.com https://*.facebook.com https://*.googletagmanager.com; connect-src 'self' https://*.google-analytics.com https://*.facebook.com;";`,
    
    'consent': `<!-- Consent Management - Vor </head> einf√ºgen: -->
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}

// Standard: Alles verweigert
gtag('consent', 'default', {
  analytics_storage: 'denied',
  ad_storage: 'denied',
  ad_user_data: 'denied',
  ad_personalization: 'denied'
});

// Nur nach Zustimmung:
function giveConsent() {
  gtag('consent', 'update', {
    analytics_storage: 'granted',
    ad_storage: 'granted',
    ad_user_data: 'granted',
    ad_personalization: 'granted'
  });
}
</script>`,
    
    'facebook_pixel': `<!-- Meta Pixel DSGVO-konform einbinden: -->
<script>
// Nur nach Consent laden
function loadFacebookPixel() {
  !function(f,b,e,v,n,t,s)
  {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
  n.callMethod.apply(n,arguments):n.queue.push(arguments)};
  if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
  n.queue=[];t=b.createElement(e);t.async=!0;
  t.src=v;s=b.getElementsByTagName(e)[0];
  s.parentNode.insertBefore(t,s)}(window, document,'script',
  'https://connect.facebook.net/en_US/fbevents.js');
  
  fbq('init', 'IHRE_PIXEL_ID');
  fbq('track', 'PageView');
}

// Nur aufrufen wenn Consent = true
</script>`,
    
    'google_analytics': `<!-- Google Analytics 4 DSGVO-konform: -->
<script async src="https://www.googletagmanager.com/gtag/js?id=GA_MEASUREMENT_ID"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}

// Consent Mode v2
gtag('consent', 'default', {
  analytics_storage: 'denied',
  ad_storage: 'denied'
});

gtag('js', new Date());
gtag('config', 'GA_MEASUREMENT_ID', {
  anonymize_ip: true,
  cookie_flags: 'secure;samesite=strict'
});
</script>`
  };
  
  // Spezielle Fixes basierend auf URL oder Issue-Details
  if (url && url.includes('facebook.com')) {
    return fixes.facebook_pixel;
  }
  if (url && url.includes('google-analytics.com')) {
    return fixes.google_analytics;
  }
  if (findingType === 'csp' || (issue && issue.toLowerCase().includes('security policy'))) {
    return fixes.csp;
  }
  if (findingType === 'consent' || (issue && issue.toLowerCase().includes('consent'))) {
    return fixes.consent;
  }
  
  return fixes[findingType] || `# Allgemeine L√∂sung f√ºr: ${findingType}
# 1. Problem identifizieren in Browser DevTools
# 2. Betroffene Domain zu CSP hinzuf√ºgen  
# 3. Consent-Management pr√ºfen
# 4. Erneut scannen zur Verifikation`;
}

// Enhanced Progress tracking
function updateDetailedProgress(stepIndex, stepProgress, currentLog) {
  const totalSteps = scanSteps.length;
  const overallProgress = ((stepIndex + stepProgress) / totalSteps) * 100;
  
  const progressBar = $('mainProgressBar');
  if (progressBar) {
    progressBar.style.width = overallProgress + '%';
  }
  
  const progressText = $('progressText');
  if (progressText) {
    const currentStep = scanSteps[stepIndex];
    progressText.innerHTML = '<div><strong>' + currentStep.name + '</strong></div>' +
      '<div style="font-size: 0.9rem; color: #6b7280; margin-top: 4px;">' + (currentLog || 'Wird verarbeitet...') + '</div>' +
      '<div style="font-size: 0.8rem; color: #9ca3af; margin-top: 2px;">Schritt ' + (stepIndex + 1) + ' von ' + totalSteps + ' (' + Math.round(overallProgress) + '%)</div>';
  }
  
  // Update milestones
  const milestones = ['milestone1', 'milestone2', 'milestone3', 'milestone4'];
  milestones.forEach(function(milestoneId, index) {
    const element = $(milestoneId);
    if (!element) return;
    
    if (index < stepIndex) {
      element.className = 'milestone completed';
      element.querySelector('.milestone-dot').textContent = '‚úì';
    } else if (index === stepIndex) {
      element.className = 'milestone active';
      element.querySelector('.milestone-dot').textContent = index + 1;
    } else {
      element.className = 'milestone pending';
      element.querySelector('.milestone-dot').textContent = index + 1;
    }
  });
  
  // Update time left
  const timeLeft = $(('timeLeft'));
  if (timeLeft) {
    const remainingTime = Math.max(5, 70 - (overallProgress * 0.7));
    timeLeft.textContent = Math.round(remainingTime);
  }
}

function addLogEntry(text, important) {
  const logDiv = $('liveLog');
  if (!logDiv) return;
  
  const entry = document.createElement('div');
  entry.className = important ? 'log-entry important' : 'log-entry';
  entry.textContent = text;
  logDiv.appendChild(entry);
  logDiv.scrollTop = logDiv.scrollHeight;
  
  // Keep only last 12 entries
  const entries = logDiv.querySelectorAll('.log-entry');
  if (entries.length > 12) {
    entries[0].remove();
  }
}

function sleep(ms) {
  return new Promise(function(resolve) { setTimeout(resolve, ms); });
}

// Real scan function with enhanced progress
async function startRealScan(url) {
  try {
    addLogEntry('üöÄ Scanner wird initialisiert...', true);
    
    // Simulate realistic progress
    for (let stepIndex = 0; stepIndex < scanSteps.length; stepIndex++) {
      const step = scanSteps[stepIndex];
      
      addLogEntry('‚ñ∂Ô∏è Starte: ' + step.name, true);
      
      for (let logIndex = 0; logIndex < step.logs.length; logIndex++) {
        const progress = logIndex / step.logs.length;
        const currentLog = step.logs[logIndex];
        
        updateDetailedProgress(stepIndex, progress, currentLog);
        addLogEntry(currentLog);
        
        await sleep(step.duration / step.logs.length);
      }
      
      await sleep(300);
    }
    
    // Complete progress
    updateDetailedProgress(3, 1, 'Analyse abgeschlossen!');
    addLogEntry('üéâ Scan erfolgreich abgeschlossen! Report wird generiert...', true);
    
    await sleep(1000);
    
    // Try actual scan, fallback to demo
    try {
      const response = await fetch('/scan', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ url: url })
      });
      
      if (response.ok) {
        const data = await response.json();
        DATA = data;
        addLogEntry('‚úÖ Live-Scan erfolgreich!', true);
      } else {
        throw new Error('Server response: ' + response.status);
      }
    } catch (e) {
      addLogEntry('üìÑ Nutze Demo-Daten (Server nicht erreichbar)', true);
      DATA = buildDemoData(url);
    }
    
    // Show results
    $('scanProgress').classList.remove('active');
    $('heroSection').style.display = 'none';
    $('exampleSection').style.display = 'none';
    $('urgencyBanner').style.display = 'none';
    $('mainApp').style.display = 'block';
    
    renderAll();
    showBanner('‚úÖ Scan abgeschlossen! ' + (DATA.summary?.totalIssues || 0) + ' Probleme gefunden.');
    
  } catch (error) {
    addLogEntry('‚ùå Fehler: ' + error.message, true);
    // Fallback
    setTimeout(function() {
      DATA = buildDemoData(url);
      $('scanProgress').classList.remove('active');
      $('mainApp').style.display = 'block';
      renderAll();
      showBanner('Demo-Daten geladen.');
    }, 2000);
  }
}

// Enhanced Demo Data
function buildDemoData(scannedUrl = 'https://demo-website.de') {
  const now = new Date().toLocaleString('de-DE');
  return {
    version: '2.5.0',
    scannedUrl: scannedUrl,
    timestamp: now,
    summary: {
      totalIssues: 8,
      highPriorityIssues: 3,
      marketingTags: [
        { name:'Google Analytics 4', property:'hasGA4', compliance:'good', impact:'üü° GA4 sendet Daten ohne Einwilligung, aber stoppt bei Ablehnung.', gdprRisk:'medium', withoutConsent:true, withAccept:true, withReject:false, businessImpact:'‚Ç¨400/Monat: Tracking l√§uft, aber rechtliches Risiko' },
        { name:'Meta Pixel (Facebook/Instagram)', property:'hasMetaPixel', compliance:'bad', impact:'üö® Meta Pixel sendet Daten trotz "Ablehnen".', gdprRisk:'high', withoutConsent:true, withAccept:true, withReject:true, businessImpact:'‚Ç¨650/Monat Werbebudget + ‚Ç¨2.000 Abmahn-Risiko' },
        { name:'Google Tag Manager', property:'hasGTM', compliance:'perfect', impact:'‚úÖ GTM mit Consent-Initialisierung erkannt.', gdprRisk:'none', withoutConsent:true, withAccept:true, withReject:true, businessImpact:'Container korrekt konfiguriert' },
        { name:'TikTok Pixel', property:'hasTikTokPixel', compliance:'missing', impact:'‚ùå Eingebunden, aber blockiert durch CSP.', gdprRisk:'none', withoutConsent:false, withAccept:false, withReject:false, businessImpact:'‚Ç¨300/Monat TikTok-Budget l√§uft blind' },
        { name:'Google Ads', property:'hasGoogleAds', compliance:'inconsistent', impact:'ü§î Conversion-Tracking inkonsistent.', gdprRisk:'medium', withoutConsent:false, withAccept:true, withReject:true, businessImpact:'‚Ç¨850/Monat suboptimale Kampagnen' }
      ]
    },
    details: {
      errors: [
        { type:'Console Error', message:'Content Security Policy: The page\'s settings blocked the loading of a resource at https://connect.facebook.net/en_US/fbevents.js', priority:'high', translation:'Meta Pixel wird durch Sicherheitsregeln blockiert', techFix:'CSP erweitern: script-src https://connect.facebook.net', url: 'https://connect.facebook.net/en_US/fbevents.js' },
        { type:'JavaScript Error', message:'Cannot read properties of undefined (reading \'getItem\')', priority:'medium', translation:'Tracking-Script findet ben√∂tigte Browser-Daten nicht', techFix:'Cookie-Handling im Script pr√ºfen und Null-Checks hinzuf√ºgen' },
        { type:'Console Error', message:'Refused to connect to https://analytics.tiktok.com/i18n/pixel/events.js', priority:'high', translation:'TikTok Pixel wird blockiert', techFix:'CSP connect-src um https://analytics.tiktok.com erweitern', url: 'https://analytics.tiktok.com/i18n/pixel/events.js' }
      ],
      networkIssues: [
        { url:'https://www.facebook.com/tr/?id=123456789', method:'GET', resourceType:'fetch', status:0, priority:'high', translation:'Meta Pixel ‚Äì ‚Ç¨650/Monat Social ROI unbekannt', techFix:'CSP/CORS f√ºr facebook.com Domains konfigurieren' },
        { url:'https://analytics.tiktok.com/api/v2/pixel/track/', method:'POST', resourceType:'fetch', status:0, priority:'high', translation:'TikTok Pixel ‚Äì ‚Ç¨300/Monat TikTok ROI unbekannt', techFix:'Firewall/CSP f√ºr analytics.tiktok.com √∂ffnen' },
        { url:'https://www.googleadservices.com/pagead/conversion/123456/?random=123', method:'GET', resourceType:'image', status:404, priority:'medium', translation:'Google Ads Conversion ‚Äì Setup pr√ºfen', techFix:'Conversion-ID in Google Ads Tag pr√ºfen' }
      ],
      cspViolations: [
        { message:'connect-src blocked https://www.facebook.com/tr/?id=123456', priority:'high', techFix:'CSP erweitern: connect-src https://www.facebook.com https://connect.facebook.net', violation: { blockedURI: 'https://www.facebook.com/tr/?id=123456', violatedDirective: 'connect-src' } },
        { message:'script-src blocked https://analytics.tiktok.com/i18n/pixel/events.js', priority:'high', techFix:'CSP erweitern: script-src https://analytics.tiktok.com', violation: { blockedURI: 'https://analytics.tiktok.com/i18n/pixel/events.js', violatedDirective: 'script-src' } }
      ]
    },
    evidence: {
      url: scannedUrl,
      generatedAt: new Date().toISOString(),
      evidence: {
        hasGA4: { 
          name: 'Google Analytics 4',
          nonTechMeaning: 'Misst Websitebesucher ohne Einwilligung zu verletzen', 
          nonTechFix: 'Consent Mode v2 aktivieren - GA4 erst nach Zustimmung senden lassen',
          modes: {
            withoutConsent: { hits: [{url: 'https://www.google-analytics.com/g/collect?...', status: 200}], trackingCookies: ['_ga', '_gid'], cspBlocks: [], dlEvents: ['page_view'] },
            withConsent: { hits: [{url: 'https://www.google-analytics.com/g/collect?...', status: 200}], trackingCookies: ['_ga', '_gid', '_gat'], cspBlocks: [], dlEvents: ['page_view', 'consent_update'] },
            withReject: { hits: [], trackingCookies: [], cspBlocks: [], dlEvents: ['consent_update'] }
          }
        },
        hasMetaPixel: { 
          name: 'Meta Pixel (Facebook/Instagram)',
          nonTechMeaning: 'Misst Facebook/Instagram-Kampagnen und baut Zielgruppen auf', 
          nonTechFix: 'Pixel nur nach Einwilligung laden - CSP-Blockaden beheben',
          modes: {
            withoutConsent: { hits: [{url: 'https://www.facebook.com/tr?id=123', status: 0}], trackingCookies: [], cspBlocks: [{message: 'CSP blocked facebook.com', directive: 'connect-src'}], dlEvents: [] },
            withConsent: { hits: [{url: 'https://www.facebook.com/tr?id=123', status: 200}], trackingCookies: ['_fbp', '_fbc'], cspBlocks: [], dlEvents: ['fbq_init'] },
            withReject: { hits: [{url: 'https://www.facebook.com/tr?id=123', status: 200}], trackingCookies: ['_fbp'], cspBlocks: [], dlEvents: ['fbq_init'] }
          }
        }
      }
    }
  };
}

// Start scan from hero
function startScanFromHero() {
  const url = $('websiteUrl').value.trim();
  if (!url) {
    alert('Bitte geben Sie eine Website-URL ein');
    return;
  }
  
  let finalUrl = url;
  if (!/^https?:\/\//.test(url)) {
    finalUrl = 'https://' + url;
    $('websiteUrl').value = finalUrl;
  }
  
  // Hide hero, show progress
  $('heroSection').style.display = 'none';
  $('exampleSection').style.display = 'none';
  $('urgencyBanner').style.display = 'none';
  $('scanProgress').classList.add('active');
  
  // Update URL display
  $('currentUrl').textContent = finalUrl;
  
  // Start the scan
  startRealScan(finalUrl);
}

// Smart Filter functionality
function smartFilter(query) {
  // This would filter the displayed results based on the query
  console.log('Filtering for:', query);
  // Implementation would go here for filtering results
}

// Export Functions
function exportResults(format) {
  if (!DATA) {
    showBanner('‚ùå Keine Daten zum Exportieren verf√ºgbar');
    return;
  }
  
  if (format === 'pdf') {
    // Simple PDF export using browser print
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
      <html>
        <head>
          <title>Website Scan Report - ${DATA.scannedUrl}</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 20px; }
            h1 { color: #7c3aed; }
            .metric { background: #f8fafc; padding: 10px; margin: 10px 0; border-left: 4px solid #ef4444; }
            .problem { margin: 15px 0; padding: 10px; border: 1px solid #e5e7eb; }
            .fix-code { background: #1a202c; color: #f7fafc; padding: 10px; font-family: monospace; }
          </style>
        </head>
        <body>
          <h1>Website-Analyse Report</h1>
          <p><strong>URL:</strong> ${DATA.scannedUrl}</p>
          <p><strong>Gescannt am:</strong> ${DATA.timestamp}</p>
          <h2>Executive Summary</h2>
          <div class="metric">
            <strong>Gefundene Probleme:</strong> ${DATA.summary.totalIssues}<br>
            <strong>Kritische Issues:</strong> ${DATA.summary.highPriorityIssues}
          </div>
          <h2>Kritische Probleme</h2>
          ${(DATA.details.errors || []).map(error => `
            <div class="problem">
              <strong>${error.type}:</strong> ${error.translation}<br>
              <div class="fix-code">${generateFixCode(error.type, error.url, error.message)}</div>
            </div>
          `).join('')}
        </body>
      </html>
    `);
    printWindow.document.close();
    printWindow.print();
    showBanner('üìÑ PDF-Export vorbereitet');
    
  } else if (format === 'csv') {
    // CSV Export
    const csvData = [
      ['Problem Type', 'Priority', 'Description', 'Business Impact', 'Technical Fix'],
      ...(DATA.details.errors || []).map(error => [
        error.type,
        error.priority,
        error.message,
        error.translation,
        error.techFix || 'Siehe technische Details'
      ])
    ];
    
    const csvContent = csvData.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `website-scan-${Date.now()}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
    showBanner('üìä CSV-Daten heruntergeladen');
  }
}

function shareResults() {
  const shareUrl = window.location.href + '?demo=' + encodeURIComponent(DATA.scannedUrl);
  
  if (navigator.share) {
    navigator.share({
      title: 'Website-Scan Ergebnisse',
      text: `${DATA.summary.totalIssues} Probleme gefunden auf ${DATA.scannedUrl}`,
      url: shareUrl
    }).then(() => {
      showBanner('üîó Erfolgreich geteilt!');
    });
  } else {
    // Fallback: Copy to clipboard
    copyToClipboard(shareUrl);
    showBanner('üîó Share-Link kopiert!');
  }
}

function scheduleRescan() {
  showBanner('‚è∞ Monitoring-Feature kommt bald!');
  // This would integrate with a backend service for scheduled rescans
}

// Render functions
function renderSummary() {
  if (!DATA) return;
  
  // Basic info
  $('scannedUrl').textContent = DATA.scannedUrl || '‚Äì';
  $('timestamp').textContent = DATA.timestamp || '‚Äì';
  $('version').textContent = 'v' + (DATA.version || '‚Äì');
  
  // Calculate money impact
  const allIssues = [
    ...(DATA.details?.errors || []).map(e => ({...e, category: 'error'})),
    ...(DATA.details?.networkIssues || []).map(n => ({...n, category: 'network'})),
    ...(DATA.details?.cspViolations || []).map(c => ({...c, category: 'csp'}))
  ];
  
  const issueHTML = allIssues.map(issue => {
    const severityClass = issue.priority === 'high' || issue.priority === 'critical' ? 'critical' : 
                         issue.priority === 'medium' ? 'warning' : 'info';
    
    const fixCode = generateFixCode(issue.category, issue.url, issue.message);
    
    return `
      <div class="problem-card ${severityClass}" onclick="toggleFix('${issue.type}_${Math.random()}')">
        <div class="problem-header">
          <div class="problem-severity severity-${severityClass.replace('critical', 'critical').replace('warning', 'warning').replace('info', 'info')}"></div>
          <div style="flex: 1;">
            <h4 style="margin: 0 0 5px 0;">${issue.translation || issue.message}</h4>
            <div style="font-size: 0.9rem; color: #6b7280;">${issue.type} ‚Ä¢ ${issue.priority}</div>
          </div>
          <div style="font-size: 1.2rem;">üí∞ ‚Ç¨${getIssueMoneyImpact(issue)}/Monat</div>
        </div>
        
        <div class="fix-section" id="fix_${issue.type}_${Math.random()}" style="display: none;">
          <h5>üîß Sofortige L√∂sung:</h5>
          <pre class="code-block"><code>${fixCode}</code></pre>
          <button onclick="copyToClipboard(\`${fixCode.replace(/`/g, '\\`')}\`); event.stopPropagation();" class="copy-btn">
            üìã Code kopieren
          </button>
          <button onclick="testFix('${issue.type}'); event.stopPropagation();" class="copy-btn" style="background: #3b82f6; margin-left: 10px;">
            üß™ Fix testen
          </button>
        </div>
      </div>
    `;
  }).join('');
  
  issueList.innerHTML = issueHTML || '<div class="empty">Keine Probleme gefunden üéâ</div>';
  
  // Update count
  const issueCount = $('issueCount');
  if (issueCount) {
    issueCount.textContent = `${allIssues.length} Probleme`;
  }
}

function getIssueMoneyImpact(issue) {
  const msg = (issue.message || '').toLowerCase();
  if (msg.includes('facebook') || msg.includes('meta')) return 650;
  if (msg.includes('google-analytics')) return 400;
  if (msg.includes('googleadservices')) return 850;
  if (msg.includes('tiktok')) return 300;
  if (msg.includes('consent') || msg.includes('gdpr')) return 200;
  return 100;
}

function toggleFix(fixId) {
  const fixElement = document.getElementById('fix_' + fixId);
  if (fixElement) {
    const isVisible = fixElement.style.display !== 'none';
    fixElement.style.display = isVisible ? 'none' : 'block';
  }
}

function testFix(issueType) {
  showBanner('üß™ Fix-Test gestartet... (Feature in Entwicklung)');
  // This would trigger a re-scan to test if the fix worked
}

function renderCompliance() {
  const complianceList = $('complianceList');
  if (!complianceList || !DATA) return;
  
  const tags = DATA.summary?.marketingTags || [];
  
  const complianceHTML = tags.map(tag => {
    let statusColor = '#10b981'; // green
    let statusIcon = '‚úÖ';
    
    if (tag.compliance === 'bad') {
      statusColor = '#ef4444';
      statusIcon = 'üö®';
    } else if (tag.compliance === 'inconsistent' || tag.compliance === 'good') {
      statusColor = '#f59e0b'; 
      statusIcon = '‚ö†Ô∏è';
    } else if (tag.compliance === 'missing') {
      statusColor = '#6b7280';
      statusIcon = '‚ùå';
    }
    
    return `
      <div class="item">
        <header onclick="toggleCompliance('${tag.property}')">
          <div class="severity" style="background: ${statusColor};"></div>
          <div class="title">${statusIcon} ${tag.name}</div>
          <div class="meta">
            <span class="chip">${tag.compliance}</span>
            <span class="chip">GDPR: ${tag.gdprRisk}</span>
          </div>
        </header>
        <div class="body" id="compliance_${tag.property}">
          <div style="margin-bottom: 15px;">
            <strong>Business Impact:</strong><br>
            ${tag.businessImpact}
          </div>
          <div style="margin-bottom: 15px;">
            <strong>Technische Analyse:</strong><br>
            ${tag.impact}
          </div>
          <div style="margin-bottom: 15px;">
            <strong>Sessions:</strong><br>
            Ohne Consent: ${tag.withoutConsent ? '‚úÖ Aktiv' : '‚ùå Inaktiv'}<br>
            Mit Accept: ${tag.withAccept ? '‚úÖ Aktiv' : '‚ùå Inaktiv'}<br>
            Mit Reject: ${tag.withReject ? '‚úÖ Aktiv (Problem!)' : '‚úÖ Gestoppt'}
          </div>
        </div>
      </div>
    `;
  }).join('');
  
  complianceList.innerHTML = complianceHTML || '<div class="empty">Keine Marketing-Tags erkannt</div>';
}

function toggleCompliance(tagId) {
  const element = document.getElementById('compliance_' + tagId);
  if (element) {
    const isOpen = element.classList.contains('open');
    element.classList.toggle('open');
    element.style.display = isOpen ? 'none' : 'block';
  }
}

function renderAll() { 
  if (!DATA) return; 
  renderSummary(); 
  renderIssuesWithFixes();
  renderCompliance();
}

// Event handlers
document.addEventListener('DOMContentLoaded', function() {
  // Hero input enter key
  const websiteUrl = $('websiteUrl');
  if (websiteUrl) {
    websiteUrl.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        startScanFromHero();
      }
    });
  }

  // Demo button
  const demoBtn = $('demoBtn');
  if (demoBtn) {
    demoBtn.addEventListener('click', function() {
      DATA = buildDemoData('https://demo.beispiel-shop.de');
      renderAll();
      showBanner('üìÑ Demo-Daten geladen - zeigt typische Probleme.');
    });
  }

  // Scan button
  const scanBtn = $('scanBtn');
  if (scanBtn) {
    scanBtn.addEventListener('click', function() {
      const url = $('url').value.trim();
      if (url) {
        startRealScan(url);
      } else {
        showBanner('‚ùå Bitte URL eingeben');
      }
    });
  }

  // Tab switching
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('tab')) {
      // Remove active from all tabs
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.grid section').forEach(section => section.style.display = 'none');
      
      // Activate clicked tab
      e.target.classList.add('active');
      const tabId = e.target.getAttribute('data-tab');
      const section = document.getElementById('tab-' + tabId);
      if (section) {
        section.style.display = 'block';
      }
    }
  });

  // Filter pills
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('filter-pill')) {
      // Toggle active state
      document.querySelectorAll('.filter-pill').forEach(pill => pill.classList.remove('active'));
      e.target.classList.add('active');
      
      const filter = e.target.getAttribute('data-filter');
      console.log('Applied filter:', filter);
      // Here you would implement the actual filtering logic
    }
  });

  // Mode toggle
  const modeManager = $('modeManager');
  const modeTech = $('modeTech');
  
  if (modeManager) {
    modeManager.addEventListener('click', function() {
      MODE = 'manager';
      modeManager.classList.add('active');
      modeTech.classList.remove('active');
      // Update display based on mode
      document.body.setAttribute('data-mode', 'manager');
    });
  }
  
  if (modeTech) {
    modeTech.addEventListener('click', function() {
      MODE = 'tech';
      modeTech.classList.add('active');
      modeManager.classList.remove('active');
      // Update display based on mode  
      document.body.setAttribute('data-mode', 'tech');
    });
  }

  // Focus URL input
  setTimeout(function() {
    if (websiteUrl) websiteUrl.focus();
  }, 300);

  // Initialize theme toggle icon
  const themeToggle = document.querySelector('.theme-toggle');
  if (themeToggle) {
    themeToggle.textContent = currentTheme === 'dark' ? '‚òÄÔ∏è' : 'üåì';
  }

  // Check for demo parameter in URL
  const urlParams = new URLSearchParams(window.location.search);
  const demoUrl = urlParams.get('demo');
  if (demoUrl) {
    setTimeout(() => {
      DATA = buildDemoData(demoUrl);
      $('heroSection').style.display = 'none';
      $('exampleSection').style.display = 'none';
      $('urgencyBanner').style.display = 'none';
      $('mainApp').style.display = 'block';
      renderAll();
      showBanner('üìÑ Geteilter Demo-Report geladen');
    }, 500);
  }
});

// Global error handler
window.addEventListener('error', function(e) {
  console.error('JavaScript Error:', e.error);
  showBanner('‚ùå Ein Fehler ist aufgetreten. Bitte Seite neu laden.');
});

// Service worker registration for PWA features (optional)
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('/sw.js').then(function(registration) {
      console.log('SW registered: ', registration);
    }).catch(function(registrationError) {
      console.log('SW registration failed: ', registrationError);
    });
  });
}
</script>
</body>
</html> []),
    ...(DATA.details?.networkIssues || []),
    ...(DATA.details?.cspViolations || [])
  ];
  
  const impact = calculateMoneyImpact(allIssues);
  
  // Update enhanced dashboard
  $('monthlyLoss').textContent = '‚Ç¨' + impact.monthlyLoss.toLocaleString();
  $('criticalCount').textContent = DATA.summary.highPriorityIssues || 0;
  $('legalRisk').textContent = '‚Ç¨' + impact.riskAmount.toLocaleString();
  $('yearlyLoss').textContent = '‚Ç¨' + impact.yearlyLoss.toLocaleString();
  
  // Update trend info
  const monthlyTrend = $('monthlyTrend');
  if (monthlyTrend) {
    if (impact.monthlyLoss > 1000) {
      monthlyTrend.textContent = 'Kritisch - sofort handeln';
      monthlyTrend.style.color = '#ef4444';
    } else if (impact.monthlyLoss > 300) {
      monthlyTrend.textContent = 'Optimierungspotential vorhanden';
      monthlyTrend.style.color = '#f59e0b';
    } else {
      monthlyTrend.textContent = 'Geringe Verluste';
      monthlyTrend.style.color = '#10b981';
    }
  }
  
  // Risk assessment
  const riskBox = $('riskBox');
  const riskText = $('riskText');
  let level = 'low';
  let text = 'Niedriges Risiko ‚Äì keine kritischen Befunde';
  
  if (DATA.summary.highPriorityIssues > 2 || impact.monthlyLoss > 1000) { 
    level = 'high'; 
    text = `Hohes Risiko ‚Äì Sie verlieren ca. ‚Ç¨${impact.monthlyLoss}/Monat durch blockierte Marketing-Tools.`; 
  } else if (DATA.summary.totalIssues > 3 || impact.monthlyLoss > 300) { 
    level = 'med'; 
    text = `Mittleres Risiko ‚Äì ${DATA.summary.totalIssues} Probleme kosten Sie ca. ‚Ç¨${impact.monthlyLoss}/Monat.`; 
  }
  
  riskBox.className = 'risk ' + level; 
  riskText.textContent = text; 
  riskBox.classList.remove('ghost'); 
  riskText.classList.remove('ghost');
}

function renderIssuesWithFixes() {
  const issueList = $('issueList');
  if (!issueList || !DATA) return;
  
  const allIssues = [
    ...(DATA.details?.errors ||
