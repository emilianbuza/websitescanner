<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ReguKit Scanner – UI Vorschau (Light, DEMO)</title>
<style>
  :root{
    --bg:#ffffff; --panel:#f9fafb; --ink:#111827; --muted:#374151;
    --brand:#7c3aed; --brand2:#22c55e; --warn:#d97706; --bad:#b91c1c; --ok:#059669;
    --chip:#f3f4f6; --border:#d1d5db;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
  a{color:inherit;text-decoration:none}
  .container{max-width:1200px;margin:0 auto;padding:16px 16px 80px}
  .topbar{position:sticky;top:0;z-index:30;background:#ffffff;border-bottom:1px solid var(--border)}
  .topbar-inner{max-width:1200px;margin:0 auto;display:flex;gap:12px;align-items:center;padding:10px 16px}
  .brand{display:flex;gap:10px;align-items:center;font-weight:700}
  .brand .dot{width:10px;height:10px;border-radius:999px;background:conic-gradient(var(--brand),var(--brand2))}
  .urlfield{flex:1;display:flex;gap:8px}
  .urlfield input{flex:1;background:#fff;border:1px solid var(--border);padding:12px 14px;border-radius:10px;color:var(--ink)}
  .btn{background:var(--brand);border:none;color:white;padding:12px 16px;border-radius:10px;font-weight:600;cursor:pointer}
  .btn.alt{background:#e5e7eb;color:#111827}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .toggle{display:flex;gap:6px;border:1px solid var(--border);border-radius:999px;padding:5px;background:#f3f4f6}
  .toggle button{border:none;padding:8px 12px;border-radius:999px;background:transparent;color:var(--ink);cursor:pointer}
  .toggle .active{background:#e5e7eb}
  .progress{height:6px;background:#f3f4f6;border-top:1px solid var(--border)}
  .progress .bar{height:100%;width:0;background:linear-gradient(90deg,var(--brand),var(--brand2));transition:width .4s ease}
  .tabs{display:flex;gap:8px;margin:16px 0}
  .tab{padding:10px 14px;border:1px solid var(--border);border-radius:10px;cursor:pointer;background:#f9fafb;color:var(--muted)}
  .tab.active{background:#e5e7eb;color:var(--ink)}
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:900px){.grid{grid-template-columns:repeat(12,1fr)}}
  .card{grid-column:span 12;background:#fff;border:1px solid var(--border);border-radius:14px;padding:16px}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#f3f4f6;border:1px solid var(--border);font-size:.85rem;color:#374151}
  .pill{padding:7px 10px;border-radius:999px;background:#f9fafb;border:1px solid var(--border);cursor:pointer}
  .pill.active{background:#e5e7eb;color:#111827}
  .kpi{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  @media(min-width:900px){.kpi{grid-template-columns:repeat(4,1fr)}}
  .kpicard{background:#fff;border:1px solid var(--border);border-radius:12px;padding:14px}
  .kpicard h3{margin:0 0 4px 0;font-size:.9rem;color:#374151}
  .kpicard .val{font-size:1.6rem;font-weight:800}
  .risk{border-radius:12px;padding:16px;border:1px solid var(--border)}
  .risk.low{background:#d1fae5}
  .risk.med{background:#fef3c7}
  .risk.high{background:#fee2e2}
  .list{display:flex;flex-direction:column;gap:8px}
  .item{background:#fff;border:1px solid var(--border);border-radius:12px;overflow:hidden}
  .item header{display:flex;gap:10px;align-items:center;padding:12px 14px;cursor:pointer}
  .item header .title{flex:1;font-weight:600}
  .severity{width:10px;height:10px;border-radius:999px}
  .sev-low{background:var(--ok)} .sev-med{background:var(--warn)} .sev-high{background:var(--bad)}
  .meta{display:flex;gap:8px;flex-wrap:wrap}
  .meta .chip{background:#f3f4f6;border:1px solid var(--border);padding:4px 8px;border-radius:999px;font-size:.8rem;color:#374151}
  .body{display:none;border-top:1px solid var(--border);padding:12px 14px}
  .body.open{display:block}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
  .toolbar input{flex:1;min-width:180px;background:#fff;border:1px solid var(--border);padding:10px;border-radius:10px;color:var(--ink)}
  .right{margin-left:auto}
  .ghost{opacity:.65}
  .drawer{position:fixed;top:0;right:-520px;width:520px;max-width:100%;height:100%;background:#fff;border-left:1px solid var(--border);
          transition:right .3s ease;z-index:50;display:flex;flex-direction:column;color:#111827}
  .drawer.open{right:0}
  .drawer header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;gap:10px;align-items:center}
  .drawer main{padding:16px;overflow:auto;display:flex;flex-direction:column;gap:12px}
  pre{background:#f9fafb;border:1px solid var(--border);border-radius:10px;padding:10px;overflow:auto;white-space:pre-wrap}
  code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
  .copy{background:#e5e7eb;border:1px solid var(--border);color:#111827;border-radius:8px;padding:6px 10px;cursor:pointer}
  .empty{padding:18px;border:1px dashed var(--border);border-radius:12px;color:#6b7280;text-align:center}
  .preview{margin-left:8px;font-size:.85rem;color:#7c3aed}
  .banner{margin:12px auto 0;max-width:1200px;background:#e0f2fe;border:1px solid #93c5fd;color:#1e3a8a;padding:10px 14px;border-radius:10px}
  .test{font-size:.85rem;color:#047857}
</style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand"><span class="dot"></span>ReguKit Scanner <span class="preview">· Vorschau (Demo-Daten)</span></div>
      <div class="urlfield">
        <input id="url" type="url" placeholder="https://ihre-website.de" />
        <button id="scanBtn" class="btn">Scan starten</button>
        <button id="demoBtn" class="btn alt">Demo laden</button>
      </div>
      <div class="toggle" title="Darstellung">
        <button id="modeManager" class="active">Manager</button>
        <button id="modeTech">Tech</button>
      </div>
    </div>
    <div class="progress"><div class="bar" id="bar"></div></div>
  </div>

  <div class="banner" id="banner" style="display:none"></div>

  <div class="container">
    <div class="tabs" id="tabs">
      <button class="tab active" data-tab="summary">Summary</button>
      <button class="tab" data-tab="compliance">Compliance</button>
      <button class="tab" data-tab="issues">Issues</button>
      <button class="tab" data-tab="evidence">Evidence</button>
    </div>

    <!-- SUMMARY -->
    <section id="tab-summary" class="grid">
      <div class="card">
        <div class="row" style="justify-content:space-between;gap:12px">
          <div class="row">
            <span class="badge" id="scannedUrl">–</span>
            <span class="badge" id="timestamp">–</span>
            <span class="badge" id="version">v–</span>
          </div>
          <div class="row">
            <span class="badge">3-Session-Test</span>
            <span class="badge">Consent Mode Check</span>
          </div>
        </div>
      </div>
      <div class="kpi card">
        <div class="kpicard"><h3>Gesamtprobleme</h3><div class="val" id="kpiTotal">–</div></div>
        <div class="kpicard"><h3>Kritisch</h3><div class="val" id="kpiCritical">–</div></div>
        <div class="kpicard"><h3>Compliance: OK</h3><div class="val" id="kpiPerfect">–</div></div>
        <div class="kpicard"><h3>Compliance: Risiko</h3><div class="val" id="kpiRisk">–</div></div>
      </div>
      <div class="card">
        <div id="riskBox" class="risk ghost"><strong>Risiko</strong><div id="riskText" class="ghost">–</div></div>
      </div>
    </section>

    <!-- COMPLIANCE -->
    <section id="tab-compliance" class="grid" style="display:none">
      <div class="card">
        <div class="toolbar">
          <span class="pill active" data-cflt="all">Alle</span>
          <span class="pill" data-cflt="perfect">Perfekt</span>
          <span class="pill" data-cflt="good">Eingeschränkt</span>
          <span class="pill" data-cflt="inconsistent">Uneinheitlich</span>
          <span class="pill" data-cflt="bad">Missachtet</span>
          <span class="pill" data-cflt="missing">Fehlt</span>
          <input id="cSearch" placeholder="Suchen (z. B. GA4, Meta, TikTok)"/>
          <div class="right row">
            <button id="expandAllCompliance" class="copy">Alle öffnen</button>
            <button id="collapseAllCompliance" class="copy">Alle schließen</button>
          </div>
        </div>
        <div class="list" id="complianceList"></div>
      </div>
    </section>

    <!-- ISSUES -->
    <section id="tab-issues" class="grid" style="display:none">
      <div class="card">
        <div class="toolbar">
          <span class="pill active" data-iflt="all">Alle</span>
          <span class="pill" data-iflt="critical">Kritisch</span>
          <span class="pill" data-iflt="high">Hoch</span>
          <span class="pill" data-iflt="medium">Mittel</span>
          <span class="pill" data-iflt="low">Niedrig</span>
          <input id="iSearch" placeholder="Filter (Domain, Meldung, Status)"/>
          <div class="right row">
            <span class="badge" id="issueCount">0 Items</span>
          </div>
        </div>
        <div class="list" id="issueList"></div>
      </div>
    </section>

    <!-- EVIDENCE -->
    <section id="tab-evidence" class="grid" style="display:none">
      <div class="card">
        <div class="empty">Wähle in Compliance oder Issues ein Element aus, um Belege anzuzeigen.</div>
      </div>
    </section>
  </div>

  <!-- Evidence Drawer -->
  <aside id="drawer" class="drawer">
    <header>
      <div class="brand"><span class="dot"></span>Evidence</div>
      <div class="right" style="margin-left:auto"><button id="drawerClose" class="copy">Schließen</button></div>
    </header>
    <main id="drawerBody"></main>
  </aside>

<script>
// Simple config: DEMO mode only (no server needed)
const CONFIG = {
  mode: 'demo',
  features: { modes: true, evidence: true, tests: false, autoDemo: true, copyButtons: true }
};

(function(){
  document.addEventListener('DOMContentLoaded', function(){
    const $ = (id)=>document.getElementById(id);

    // DOM
    const urlEl=$('url'), scanBtn=$('scanBtn'), demoBtn=$('demoBtn'), bar=$('bar');
    const tabs=document.querySelectorAll('.tab');
    const sections={ summary:$('tab-summary'), compliance:$('tab-compliance'), issues:$('tab-issues'), evidence:$('tab-evidence') };
    const modeManager=$('modeManager'), modeTech=$('modeTech');
    const banner=$('banner');
    const drawer=$('drawer'), drawerBody=$('drawerBody'); const drawerClose=$('drawerClose');
    const cList=$('complianceList'), cSearch=$('cSearch'); const iList=$('issueList'), iSearch=$('iSearch');

    let MODE='manager';
    let DATA=null;

    // Helpers
    function escapeHtml(s){ return String(s||'').replace(/[&<>\"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;' }[c])); }
    function escapeAttr(s){ return escapeHtml(s).replace(/\"/g,'&quot;'); }
    function tryHost(u){ try{ return new URL(u).hostname }catch(e){ return u; } }
    function showBanner(msg){ if(!banner) return; banner.textContent = msg; banner.style.display='block'; setTimeout(()=> banner.style.display='none', 2500); }

    // Tabs
    tabs.forEach(t=> t.addEventListener('click', ()=>{
      tabs.forEach(x=>x.classList.remove('active')); t.classList.add('active');
      const key=t.dataset.tab; Object.entries(sections).forEach(([k,el])=> el && (el.style.display=(k===key)?'grid':'none'));
    }));

    // Mode
    modeManager && (modeManager.onclick=()=>{ MODE='manager'; modeManager.classList.add('active'); modeTech?.classList.remove('active'); applyModeVisibility(); });
    modeTech && (modeTech.onclick=()=>{ MODE='tech'; modeTech.classList.add('active'); modeManager?.classList.remove('active'); applyModeVisibility(); });

    // Progress
    let progInt; function startProgress(){ if(!bar) return; bar.style.width='0%'; let p=0; clearInterval(progInt); progInt=setInterval(()=>{ p=Math.min(100,p+8); bar.style.width=p+'%'; }, 180); }
    function endProgress(){ if(!bar) return; clearInterval(progInt); bar.style.width='100%'; setTimeout(()=>bar.style.width='0%', 500); }

    // Scan (disabled in DEMO)
    scanBtn && scanBtn.addEventListener('click', ()=> alert('Dies ist eine Vorschau. Klicke auf „Demo laden“.'));

    // Demo
    demoBtn && demoBtn.addEventListener('click', ()=>{ startProgress(); setTimeout(()=>{ DATA=buildDemoData(); renderAll(); endProgress(); showBanner('Demo-Daten geladen.'); }, 300); });

    // Drawer
    drawerClose && (drawerClose.onclick=()=> drawer?.classList.remove('open'));
    function openEvidence(title, ev, tag, issue){
      if(!CONFIG.features.evidence || !drawer || !drawerBody) return;
      drawerBody.innerHTML='';
      const h=document.createElement('div'); h.innerHTML='<h2 style="margin:0 0 8px 0">'+escapeHtml(title)+'</h2>'; drawerBody.appendChild(h);
      if(ev){ drawerBody.appendChild(evidenceBlock('Ohne Einwilligung', ev?.modes?.withoutConsent));
              drawerBody.appendChild(evidenceBlock('Mit Einwilligung', ev?.modes?.withConsent));
              drawerBody.appendChild(evidenceBlock('Bei Ablehnen', ev?.modes?.withReject)); }
      else if(issue){ const d=document.createElement('div'); d.innerHTML='<pre>'+escapeHtml(JSON.stringify(issue,null,2))+'</pre>'; drawerBody.appendChild(d); }
      else { drawerBody.innerHTML='<div class="empty">Keine Belege verfügbar.</div>'; }
      drawer.classList.add('open');
    }
    function evidenceBlock(label, m){
      const el=document.createElement('div'); if(!m){ el.innerHTML='<div class="empty">'+escapeHtml(label)+': –</div>'; return el; }
      const hits=(m.hits||[]).map(h=>'• '+h.url+' ('+(h.status||0)+')').join('\\n')||'– keine Datenübertragungen sichtbar';
      const cook=(m.trackingCookies||[]).map(c=>'• '+c).join('\\n')||'– keine neuen Einträge';
      const csps=(m.cspBlocks||[]).map(c=>'• '+c.message).join('\\n')||'– keine Verbindungen verhindert';
      const dls=(m.dlEvents||[]).map(e=>'• '+e).join('\\n')||'– keine Einträge';
      el.innerHTML='<div><h3 style="margin:8px 0">'+escapeHtml(label)+'</h3>'+
        '<strong>Nachweis im Browser (Network):</strong><pre>'+escapeHtml(hits)+'</pre>'+
        '<strong>Neue Einträge im Browser-Speicher:</strong><pre>'+escapeHtml(cook)+'</pre>'+
        '<strong>Sicherheitsregeln verhinderten Verbindungen:</strong><pre>'+escapeHtml(csps)+'</pre>'+
        '<strong>Interne Ereignisliste (IT):</strong><pre>'+escapeHtml(dls)+'</pre></div>';
      return el;
    }

    // Render Summary
    function renderSummary(){
      if(!DATA) return;
      $('scannedUrl').textContent=DATA.scannedUrl||'–';
      $('timestamp').textContent=DATA.timestamp||'–';
      $('version').textContent='v'+(DATA.version||'–');
      const total=(DATA.details?.errors?.length||0)+(DATA.details?.networkIssues?.length||0)+(DATA.details?.cspViolations?.length||0);
      const crit=(DATA.details?.errors||[]).filter(e=>/critical/i.test(e.priority||'')).length +
                  (DATA.details?.networkIssues||[]).filter(e=>(/critical|high/i).test(e.priority||'')).length +
                  (DATA.details?.cspViolations||[]).filter(e=>(/critical|high/i).test(e.priority||'')).length;
      const mtags=DATA.summary?.marketingTags||[];
      const perfect=mtags.filter(m=>m.compliance==='perfect').length;
      const risk=mtags.filter(m=>['bad','inconsistent','good','missing'].includes(m.compliance)).length;
      $('kpiTotal').textContent=total; $('kpiCritical').textContent=crit; $('kpiPerfect').textContent=perfect; $('kpiRisk').textContent=risk;
      const riskBox=$('riskBox'), riskText=$('riskText');
      let level='low', text='Niedriges Risiko – keine kritischen Befunde';
      if(crit>0){ level='high'; text='Hohes Risiko – kritische Probleme und/oder Einwilligung missachtet.'; }
      else if(total>0){ level='med'; text='Mittleres Risiko – einige Probleme erfordern Aufmerksamkeit.'; }
      riskBox.className='risk '+level; riskText.textContent=text; riskBox.classList.remove('ghost'); riskText.classList.remove('ghost');
    }

    // Compliance
    const cPills=document.querySelectorAll('[data-cflt]'); let cFilter='all';
    cPills.forEach(p=>p.onclick=()=>{ cPills.forEach(x=>x.classList.remove('active')); p.classList.add('active'); cFilter=p.dataset.cflt; drawCompliance(); });
    cSearch && (cSearch.oninput=()=> drawCompliance());

    function drawCompliance(){
      if(!DATA){ cList.innerHTML=''; return; }
      const q=(cSearch?.value||'').toLowerCase();
      let items=(DATA.summary?.marketingTags||[]).map(m=>({ name:m.name||m.property, compliance:m.compliance, tag:m, ev:(DATA.evidence?.evidence||{})[m.property] }));
      items=items.filter(x=> (cFilter==='all'||x.compliance===cFilter) && (x.name||'').toLowerCase().includes(q));
      if(!items.length){ cList.innerHTML='<div class="empty">Keine Einträge.</div>'; return; }
      cList.innerHTML=items.map((x,i)=> complianceItemHTML(x,i)).join('');
      items.forEach((x,i)=>{
        const hdr=$('c-h'+i), body=$('c-b'+i); hdr && body && (hdr.onclick=()=> body.classList.toggle('open'));
        const evBtn=$('c-e'+i); evBtn && evBtn.addEventListener('click', ()=> openEvidence(x.name, x.ev, x.tag));
        document.querySelectorAll('.copy-fix-'+i).forEach(btn=> btn.addEventListener('click', ()=> navigator.clipboard.writeText(btn.dataset.fix||'')));
      });
      applyModeVisibility();
    }
    function complianceItemHTML(x,i){
      const sevClass=({ perfect:'sev-low', good:'sev-med', inconsistent:'sev-med', bad:'sev-high', missing:'sev-med' })[x.compliance]||'sev-med';
      const badge=({ perfect:'Einwilligung korrekt', good:'Eingeschränkt', inconsistent:'Uneinheitlich', bad:'Missachtet', missing:'Fehlt/keine Daten' })[x.compliance]||'Hinweis';
      const t=x.tag||{};
      const matrix=`
        <div class="row" style="gap:8px;flex-wrap:wrap">
          <span class="chip">Ohne Einwilligung: ${t.withoutConsent? 'Daten gesendet' : 'Keine Daten'}</span>
          <span class="chip">Mit Einwilligung: ${t.withAccept? 'Daten gesendet' : 'Keine Daten'}</span>
          <span class="chip">Bei Ablehnen: ${t.withReject? 'Daten gesendet' : 'Keine Daten'}</span>
        </div>`;
      const impactManager=(t.impact||'Hinweis zur Einbindung.').replace(/HITs?/ig,'Datenübertragungen');
      const impactTech=(t.businessImpact? (t.businessImpact+' — '):'') + impactManager;
      const fixText=(DATA?.evidence?.evidence?.[t.property]?.nonTechFix)||'Im Tag Manager/CMP sicherstellen, dass das Tool nur nach Einwilligung auslöst.';
      return `
        <div class="item">
          <header id="c-h${i}">
            <span class="severity ${sevClass}"></span>
            <div class="title">${x.name}</div>
            <div class="meta"><span class="chip">${badge}</span></div>
          </header>
          <div class="body" id="c-b${i}">
            <div class="row" style="gap:10px;align-items:flex-start">
              <div style="flex:2;min-width:260px">
                <div class="ghost" data-mode="manager"><strong>Warum wichtig:</strong> ${(DATA?.evidence?.evidence?.[t.property]?.nonTechMeaning)||'Ohne diese Daten können Besucherzahlen/Kampagnen nicht ausgewertet werden.'}</div>
                <div style="margin-top:8px"><strong>Bewertung:</strong> <span>${MODE==='manager'? impactManager : impactTech}</span></div>
                <div style="margin-top:10px">${matrix}</div>
              </div>
              <div style="flex:1;min-width:220px">
                <div><strong>Empfohlene Lösung</strong></div>
                <pre><code>${fixText}</code></pre>
                <button class="copy copy-fix-${i}" data-fix="${escapeAttr(fixText)}" data-mode="tech">Copy Fix (Tech)</button>
              </div>
            </div>
            <div class="row" style="margin-top:10px">
              <button id="c-e${i}" class="copy">Belege anzeigen</button>
            </div>
          </div>
        </div>`;
    }

    // Issues
    const iPills=document.querySelectorAll('[data-iflt]'); let iFilter='all';
    iPills.forEach(p=>p.onclick=()=>{ iPills.forEach(x=>x.classList.remove('active')); p.classList.add('active'); iFilter=p.dataset.iflt; drawIssues(); });
    iSearch && (iSearch.oninput=()=> drawIssues());

    function drawIssues(){
      if(!DATA){ iList.innerHTML=''; return; }
      const items=[].concat((DATA.details?.errors||[]).map(x=>({...x,_kind:'Console Error'})))
                    .concat((DATA.details?.networkIssues||[]).map(x=>({...x,_kind:'Network Issue'})))
                    .concat((DATA.details?.cspViolations||[]).map(x=>({...x,_kind:'CSP Violation'})));
      let filtered=items;
      const q=(iSearch?.value||'').toLowerCase();
      if(q){ filtered=filtered.filter(x=>(x.message||'').toLowerCase().includes(q)||(x.url||'').toLowerCase().includes(q)||String(x.status||'').toLowerCase().includes(q)||(x._kind||'').toLowerCase().includes(q)); }
      $('issueCount').textContent=filtered.length+' Items';
      if(!filtered.length){ iList.innerHTML='<div class="empty">Keine Issues für den aktuellen Filter.</div>'; return; }
      iList.innerHTML=filtered.slice(0,250).map((x,i)=> issueItemHTML(x,i)).join('');
      filtered.slice(0,250).forEach((x,i)=>{
        const hdr=$('i-h'+i), body=$('i-b'+i); hdr && body && (hdr.onclick=()=> body.classList.toggle('open'));
        const evBtn=$('i-e'+i); evBtn && evBtn.addEventListener('click', ()=> openEvidence(x._kind, null, null, x));
        const copyBtn=$('i-fix'+i); copyBtn && (copyBtn.onclick=()=> navigator.clipboard.writeText(copyBtn.dataset.fix||''));
      });
      applyModeVisibility();
    }
    function issueItemHTML(x,i){
      const sevClass=(/(critical|high)/i.test(x.priority||''))?'sev-high':(/(medium)/i.test(x.priority||''))?'sev-med':'sev-low';
      const title=(x._kind||'Issue')+(x.url?(' · '+tryHost(x.url)):'');
      const business=/CSP|security|blocked|googletagmanager|googleadservices|facebook|tiktok|hotjar/i.test(x.message||'')?
        'Marketing-/Messdienst beeinträchtigt; Auswertungen lückenhaft.' : 'Funktionen der Seite können ausfallen; Mess-/Marketingdaten können fehlen.';
      const fix=x.techFix||'IT prüfen: CSP/CORS/Erreichbarkeit und Einbindung korrigieren.';
      const detailL=(x.message||('Status: '+(x.status??'-')))+(x.url?('\\nURL: '+x.url):'');
      return `
        <div class="item">
          <header id="i-h${i}">
            <span class="severity ${sevClass}"></span>
            <div class="title">${escapeHtml(title)}</div>
            <div class="meta"><span class="chip">${escapeHtml(x.priority||'-')}</span><span class="chip">${escapeHtml(x._kind||'-')}</span></div>
          </header>
          <div class="body" id="i-b${i}">
            <div class="row" style="gap:10px;align-items:flex-start">
              <div style="flex:2;min-width:260px">
                <div class="ghost" data-mode="manager"><strong>Verständlich:</strong> ${escapeHtml(x.translation||'Eine Verbindung zu einem externen Dienst hat nicht funktioniert.')}</div>
                <div style="margin-top:8px"><strong>Business-Auswirkung:</strong> ${escapeHtml(business)}</div>
                <div style="margin-top:8px"><strong>Details:</strong><pre>${escapeHtml(detailL)}</pre></div>
              </div>
              <div style="flex:1;min-width:220px">
                <div><strong>Empfohlene Lösung</strong></div>
                <pre><code>${escapeHtml(fix)}</code></pre>
                <button id="i-fix${i}" class="copy" data-mode="tech" data-fix="${escapeAttr(fix)}">Copy Fix (Tech)</button>
              </div>
            </div>
            <div class="row" style="margin-top:10px">
              <button id="i-e${i}" class="copy">Belege anzeigen</button>
            </div>
          </div>
        </div>`;
    }

    // Mode-abhängige Sichtbarkeit
    function applyModeVisibility(){
      document.querySelectorAll('[data-mode="tech"]').forEach(el=> el.style.display = (MODE==='tech')?'inline-flex':'none');
      document.querySelectorAll('[data-mode="manager"]').forEach(el=> el.style.display = (MODE==='manager')?'block':'none');
    }
    function renderAll(){ if(!DATA) return; renderSummary(); drawCompliance(); drawIssues(); }

    // DEMO DATA
    function buildDemoData(){
      const now = new Date().toLocaleString('de-DE');
      const evidence = {
        url: 'https://demo.regukit.de',
        generatedAt: new Date().toISOString(),
        evidence: {
          hasGA4: {
            name: 'Google Analytics 4',
            modes: {
              withoutConsent: { hits: [], trackingCookies: [], cspBlocks: [], dlEvents: ['consent','gtm.init'] },
              withConsent:    { hits: [{url:'https://region1.google-analytics.com/g/collect?v=2&tid=G-XXXX', status:204}], trackingCookies:['_ga (Domain: .demo.regukit.de)'], cspBlocks: [], dlEvents: ['consent.update','page_view'] },
              withReject:     { hits: [], trackingCookies: [], cspBlocks: [], dlEvents: ['consent.update'] }
            },
            howToVerify: [
              'Browser-Werkzeuge öffnen → Tab "Network" → nach "g/collect" filtern',
              'Seite neu laden und Status prüfen (200/204)',
              'Im Tab "Application/Speicher" nach _ga suchen'
            ],
            nonTechMeaning: 'Misst Besucher & Seitenaufrufe. Ohne Einwilligung dürfen keine Daten an Google gesendet werden.',
            nonTechFix: 'Consent Mode aktivieren und GA4-Tag nur nach Einwilligung auslösen.'
          },
          hasMetaPixel: {
            name: 'Meta Pixel (Facebook/Instagram)',
            modes: {
              withoutConsent: { hits: [], trackingCookies: [], cspBlocks: [], dlEvents: [] },
              withConsent:    { hits: [{url:'https://www.facebook.com/tr/?id=12345&ev=PageView', status:200}], trackingCookies:['_fbp (Domain: .demo.regukit.de)'], cspBlocks: [], dlEvents: [] },
              withReject:     { hits: [], trackingCookies: [], cspBlocks: [{message:'connect-src blocked https://www.facebook.com/tr/?id=12345'}], dlEvents: [] }
            },
            howToVerify: ['Network → Filter "tr?id="', 'Konsole → CSP-Meldungen prüfen'],
            nonTechMeaning: 'Misst Kampagnen-Erfolg bei Facebook/Instagram.',
            nonTechFix: 'Pixel nur nach Einwilligung & per GTM mit Consent-Prüfung auslösen.'
          },
          hasGTM: {
            name: 'Google Tag Manager',
            modes: {
              withoutConsent: { hits: [], trackingCookies: [], cspBlocks: [], dlEvents: ['consent','gtm.init'] },
              withConsent:    { hits: [], trackingCookies: [], cspBlocks: [], dlEvents: ['consent.update','gtm.js'] },
              withReject:     { hits: [], trackingCookies: [], cspBlocks: [], dlEvents: ['consent.update'] }
            },
            howToVerify: ['Konsole: window.dataLayer?.slice(-10)', 'GTM-Preview prüfen'],
            nonTechMeaning: 'Container für Marketing-Tags.',
            nonTechFix: 'Consent-Initialisierung vor allen Tags, Standard = abgelehnt.'
          }
        }
      };

      return {
        version: '2.4.0',
        scannedUrl: 'https://demo.regukit.de',
        timestamp: now,
        summary: {
          totalIssues: 7,
          highPriorityIssues: 2,
          marketingTags: [
            { name:'Google Analytics 4', property:'hasGA4', compliance:'perfect', impact:'✅ GA4 respektiert die Einwilligung.', gdprRisk:'none', withoutConsent:false, withAccept:true, withReject:false, businessImpact:'Besucherdaten DSGVO-konform.' },
            { name:'Meta Pixel (Facebook/Instagram)', property:'hasMetaPixel', compliance:'inconsistent', impact:'🤔 Uneinheitliches Verhalten, teils CSP-Blockaden.', gdprRisk:'medium', withoutConsent:false, withAccept:true, withReject:false, businessImpact:'Social ROI nur teilweise messbar.' },
            { name:'Google Tag Manager', property:'hasGTM', compliance:'perfect', impact:'✅ Consent default denied vorhanden.', gdprRisk:'none', withoutConsent:true, withAccept:true, withReject:true, businessImpact:'Steuert Tags korrekt nach Einwilligung.' },
            { name:'TikTok Pixel', property:'hasTikTokPixel', compliance:'missing', impact:'❌ Eingebunden, aber keine Datenübertragungen erkannt.', gdprRisk:'none', withoutConsent:false, withAccept:false, withReject:false, businessImpact:'TikTok-Kampagnen nicht messbar.' }
          ],
          consentCompliance: {}
        },
        details: {
          errors: [
            { type:'Console Error', message:'Content Security Policy: The page’s settings blocked the loading of a resource at https://connect.facebook.net', priority:'high', translation:'Sicherheits­einstellungen blockieren Verbindungen.', techFix:'CSP connect-src um connect.facebook.net erweitern.' },
            { type:'Console Error', message:'Deprecated gtag command used', priority:'medium', translation:'Veraltete API-Nutzung', techFix:'gtag Aufrufe aktualisieren.' }
          ],
          networkIssues: [
            { url:'https://www.facebook.com/tr/?id=12345', method:'GET', resourceType:'fetch', status:0, priority:'high', translation:'Meta Pixel – Social ROI unbekannt.', techFix:'CSP/CORS prüfen' },
            { url:'https://analytics.tiktok.com/i18n/pixel/events.js', method:'GET', resourceType:'script', status:404, priority:'medium', translation:'TikTok Pixel – unoptimiert.', techFix:'Script-URL prüfen' }
          ],
          cspViolations: [
            { message:'connect-src blocked https://www.facebook.com/tr/?id=12345', priority:'high', techFix:'connect-src https://www.facebook.com zulassen' }
          ]
        },
        evidence
      };
    }

    // First run
    setTimeout(()=>{ demoBtn && demoBtn.click(); urlEl && urlEl.focus(); }, 300);
  });
})();
</script>
</body>
</html>
